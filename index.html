<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
	<meta name="apple-mobile-web-app-capable" content="yes">
	<meta name="mobile-web-app-capable" content="yes">
	<title>„Å≤„Çâ„Éñ„É™ÔºÅ- Hira Buri! - Kana Blitz Game</title>

	<link href="https://fonts.googleapis.com/css2?family=Yomogi&family=Kosugi+Maru&family=Kaisei+Tokumin:wght@400;700&family=Kaisei+Decol:wght@400;700&family=Zen+Kurenaido&family=Sawarabi+Mincho&family=Sawarabi+Gothic&family=Dela+Gothic+One&family=RocknRoll+One&family=Hachi+Maru+Pop&family=Noto+Sans+JP:wght@400;700&family=Yuji+Mai&family=Yuji+Syuku&family=Yuji+Boku&family=Reggae+One&family=Train+One&family=Hina+Mincho&family=Press+Start+2P&family=Orbitron:wght@400;700&display=swap" rel="stylesheet">

<style>
/* ============================================
   CSS VARIABLES (Theme Colors)
   ============================================ */

/* DAWN MINIMALIST THEME (Default) */
:root {
	--primary-color: #4A4035;
	--secondary-color: #6B5D4D;
	--bg-color: #F5F0E8;
	--bg-grid: #EDE8E0;
	--light-text: #2D261F;
	--font-family: helvetica, sans-serif;
	
	/* Dawn theme specific colors */
	--accent-color: rgba(107, 93, 77, 1);
	--accent-light: rgba(107, 93, 77, 0.4);
	--accent-lighter: rgba(107, 93, 77, 0.25);
	--accent-lightest: rgba(107, 93, 77, 0.15);
	--card-bg: rgba(255, 255, 255, 0.4);
	--card-border: rgba(107, 93, 77, 0.3);
	--card-shadow: rgba(107, 93, 77, 0.2);
	--correct-bg: rgba(139, 168, 106, 0.35);
	--correct-border: #8BA86A;
	--correct-text: #5C7A3D;
	--incorrect-bg: rgba(180, 100, 90, 0.35);
	--incorrect-border: #B4645A;
	--incorrect-text: #8B4840;
	--ground-line-color: #B4645A;
}

/* MIDNIGHT SKY THEME */
body.midnight-theme {
	--primary-color: #E8E4F0;
	--secondary-color: #B8B4C8;
	--bg-color: #0a0e1a;
	--bg-grid: #12162a;
	--light-text: #F0ECF8;
	
	/* Midnight theme specific colors */
	--accent-color: rgba(123, 104, 238, 1);
	--accent-light: rgba(123, 104, 238, 0.4);
	--accent-lighter: rgba(123, 104, 238, 0.25);
	--accent-lightest: rgba(123, 104, 238, 0.15);
	--card-bg: rgba(20, 25, 50, 0.85);
	--card-border: rgba(123, 104, 238, 0.3);
	--card-shadow: rgba(0, 0, 0, 0.3);
	--correct-bg: rgba(100, 220, 150, 0.25);
	--correct-border: #64DC96;
	--correct-text: #90EEB8;
	--incorrect-bg: rgba(255, 100, 130, 0.25);
	--incorrect-border: #FF6482;
	--incorrect-text: #FF8FA8;
	--ground-line-color: #FF6482;
	
	background: linear-gradient(180deg, #0a0e1a 0%, #1a1e3a 50%, #0d1225 100%);
	background-attachment: fixed;
}

/* ============================================
   RESET & BASE STYLES
   ============================================ */

* {
	margin: 0;
	padding: 0;
	box-sizing: border-box;
}

html {
	overscroll-behavior: none;
}

body {
	background-color: var(--bg-color);
	background-image: 
		linear-gradient(90deg, var(--bg-grid) 1px, transparent 1px),
		linear-gradient(var(--bg-grid) 1px, transparent 1px);
	background-size: 0.3rem 0.3rem;
	color: var(--secondary-color);
	font-family: var(--font-family);
	font-weight: 300;
	min-height: 100vh;
	min-height: 100dvh;
	display: flex;
	flex-direction: column;
	letter-spacing: 0.03rem;
	overflow-x: hidden;
	position: relative;
}

body.gameplay-active {
	overflow: hidden;
	height: 100vh;
	height: 100dvh;
}

body.gameplay-active #app {
	height: 100vh;
	height: 100dvh;
	overflow: hidden;
	display: flex;
	align-items: center;
	justify-content: center;
}

/* ============================================
   LAYOUT - Main Containers
   ============================================ */

#app {
	flex: 1;
	position: relative;
	z-index: 1;
	padding: 2rem 1rem;
}

.container {
	max-width: 600px;
	margin: 0 auto;
	padding: 0 2rem;
}

.game-container {
	min-height: 100vh;
	display: flex;
	flex-direction: column;
	align-items: center;
	justify-content: center;
	width: 100%;
}

/* ============================================
   LAYOUT - Cards
   ============================================ */

.card {
	background: var(--card-bg);
	padding: 2.5rem;
	border: 2px solid var(--card-border);
	width: 100%;
	max-width: 600px;
	margin: 1rem auto;
	box-shadow: 5px 5px 0 var(--card-shadow);
	position: relative;
	animation: fadeIn 0.5s ease-out;
}

.large-card:before {
	position: absolute;
	top: 0;
	left: -1.5rem;
	bottom: 0;
	height: 100%;
	width: 0.3rem;
	border: solid var(--accent-light);
	border-width: 0 0.2rem 0 0.6rem;
}

/* ============================================
   LAYOUT - Typography
   ============================================ */

h1 {
	font-size: 2rem;
	margin-bottom: 0.5rem;
	font-family: 'Kaisei Decol', serif;
	font-weight: 300;
	text-transform: uppercase;
	letter-spacing: 0.5rem;
	text-shadow: 0.3rem 0.3rem 0 var(--card-shadow);
}

h2 {
	font-size: 2rem;
	margin-bottom: 1.5rem;
	font-family: 'Kaisei Decol', serif;
	font-weight: 300;
	text-transform: uppercase;
	letter-spacing: 0.3rem;
}

blockquote {
	position: relative;
	padding: 0.5rem;
}

blockquote:before {
	content: '';
	position: absolute;
	top: 0;
	left: -1.5rem;
	bottom: 0;
	height: 100%;
	width: 0.3rem;
	border: solid var(--accent-light);
	border-width: 0 0.2rem 0 0.6rem;
}

.subtitle {
	color: var(--secondary-color);
	font-size: 1rem;
	font-weight: 500;
}

/* ============================================
   LAYOUT - Buttons
   ============================================ */

.btn, button {
	cursor: pointer;
	font: inherit;
	letter-spacing: 0.05rem;
	border: none;
	padding: 0.8rem 1.5rem;
	background-color: var(--accent-lighter);
	color: var(--primary-color);
	border: 1px solid transparent;
	border-left: none;
	border-right: none;
	transition-duration: 0.2s;
	transition-property: color, background-color, box-shadow;
	position: relative;
	z-index: 1;
	font-weight: 400;
}

.btn::before, button::before {
	content: "";
	position: absolute;
	z-index: -1;
	left: 0;
	top: 3px;
	bottom: 3px;
	width: 0;
	background-color: var(--primary-color);
	transition: width 0.2s;
}

.btn:hover, button:hover,
.btn:focus, button:focus {
	background-color: transparent;
	color: var(--light-text);
	border-color: var(--primary-color);
}

.btn:hover::before, button:hover::before,
.btn:focus::before, button:focus::before {
	width: 100%;
}

.btn-group {
	display: flex;
	gap: 1rem;
	width: 100%;
	flex-wrap: wrap;
}

.btn-group .btn {
	flex: 1;
	min-width: 140px;
}

/* ============================================
   LAYOUT - Playing Area
   ============================================ */

.playing-area {
	display: flex;
	flex-direction: column;
	align-items: center;
	gap: 2rem;
	width: 100%;
}

.stats-bar {
	display: flex;
	justify-content: space-between;
	width: 100%;
	padding: 1rem;
	background: var(--accent-lightest);
	border: 2px solid var(--accent-light);
	font-family: 'Orbitron', monospace;
}

.stat {
	display: flex;
	flex-direction: column;
	align-items: center;
}

.stat-label {
	font-size: 0.75rem;
	opacity: 0.7;
	text-transform: uppercase;
	letter-spacing: 0.1rem;
}

.stat-value {
	font-size: 1.5rem;
	font-weight: bold;
}

/* ============================================
   LAYOUT - Kana Display
   ============================================ */

.kana-display {
	font-size: 8rem;
	font-weight: bold;
	text-align: center;
	min-height: 220px;
	display: flex;
	align-items: center;
	justify-content: center;
	background: var(--card-bg);
	border: 3px solid var(--card-border);
	padding: 2rem;
	width: 100%;
	color: var(--primary-color);
	font-family: 'Zen Kurenaido', serif;
	box-shadow: 5px 5px 0 var(--card-shadow);
	position: relative;
	overflow: hidden;
}

.kana-character {
	position: absolute;
	top: 0;
	left: 50%;
	transform: translateX(-50%);
	font-size: 9rem;
	font-weight: 700;
}

.kana-character.random-font { 
	transition: font-family 0.3s ease-in-out; 
}

.kana-text {
	font-weight: 700;
}

.kana-character.falling {
	animation: fall linear forwards;
}

.ground-line {
	position: absolute;
	bottom: 0;
	left: 0;
	right: 0;
	height: 4px;
	background: var(--ground-line-color);
}

.feedback {
	position: absolute;
	bottom: 2rem;
	left: 50%;
	transform: translateX(-50%);
	font-size: 1.5rem;
	font-weight: 700;
	white-space: nowrap;
}

.feedback.correct {
	color: var(--correct-text);
}

.feedback.incorrect {
	color: var(--incorrect-text);
}

/* Floating Exit Button */
.floating-controls {
	position: fixed;
	top: 1rem;
	right: 1rem;
	z-index: 1000;
}

.floating-btn {
	padding: 0.5rem 1rem;
	font-size: 0.9rem;
	background: var(--card-bg);
	border: 2px solid var(--card-border);
	cursor: pointer;
}

/* ============================================
   LAYOUT - Answer Buttons
   ============================================ */

.answer-grid {
	display: grid;
	grid-template-columns: repeat(2, 1fr);
	gap: 1rem;
	width: 100%;
}

.answer-button {
	padding: 1.5rem;
	font-size: 1.25rem;
	background: var(--card-bg);
	border: 2px solid var(--accent-light);
	cursor: pointer;
	transition: all 0.3s ease;
	color: var(--primary-color);
	font-family: var(--font-family);
	font-weight: 600;
	position: relative;
}

.answer-button::before {
	content: "";
	position: absolute;
	z-index: -1;
	left: 0;
	top: 3px;
	bottom: 3px;
	width: 0;
	background-color: var(--primary-color);
	transition: width 0.2s;
}

.answer-button:hover {
	background-color: transparent;
	color: var(--light-text);
	border-color: var(--primary-color);
}

.answer-button:hover::before {
	width: 100%;
}

.answer-button.correct {
	background: var(--correct-bg);
	border-color: var(--correct-border);
	color: var(--correct-text);
}

.answer-button.incorrect {
	background: var(--incorrect-bg);
	border-color: var(--incorrect-border);
	color: var(--incorrect-text);
}

.answer-button:disabled {
	cursor: not-allowed;
	opacity: 0.7;
}

/* ============================================
   LAYOUT - Progress Bar
   ============================================ */

.progress-container {
	width: 100%;
	margin: 1rem 0;
}

.progress-bar {
	width: 100%;
	height: 8px;
	background: var(--accent-lightest);
	border: 1px solid var(--accent-light);
	overflow: hidden;
}

.progress-fill {
	height: 100%;
	background: var(--primary-color);
	transition: width 0.5s ease;
}

.progress-fill.green {
	background: #4caf50;
}

/* ============================================
   LAYOUT - Game Over
   ============================================ */

.game-over-container {
	text-align: center;
}

.final-score {
	font-size: 4rem;
	font-weight: bold;
	color: var(--primary-color);
	margin: 1rem 0;
	text-shadow: 3px 3px 0 var(--card-shadow);
}

.score-details {
	display: grid;
	grid-template-columns: repeat(2, 1fr);
	gap: 1rem;
	margin: 2rem 0;
}

.score-item {
	background: var(--accent-lightest);
	padding: 1.5rem;
	border: 2px solid var(--card-border);
}

.score-item-label {
	font-size: 0.9rem;
	opacity: 0.7;
	text-transform: uppercase;
	letter-spacing: 0.1rem;
}

.score-item-value {
	font-size: 2rem;
	font-weight: bold;
	margin-top: 0.5rem;
}

.new-record-badge {
	display: inline-block;
	background: var(--primary-color);
	color: var(--light-text);
	padding: 0.5rem 1.5rem;
	border: 2px solid var(--primary-color);
	font-weight: bold;
	font-size: 1.25rem;
	margin: 1rem 0;
	box-shadow: 3px 3px 0 var(--card-shadow);
}

/* ============================================
   LAYOUT - Tabs & Leaderboard
   ============================================ */

.tabs {
	display: flex;
	gap: 0.5rem;
	margin-bottom: 1.5rem;
}

.tab {
	flex: 1;
	padding: 0.75rem;
	background: var(--accent-lightest);
	border: 2px solid var(--card-border);
	cursor: pointer;
	transition: all 0.3s ease;
	font-family: var(--font-family);
	font-size: 0.9rem;
}

.tab:hover {
	background: var(--accent-lighter);
}

.tab.active {
	background: var(--primary-color);
	color: var(--light-text);
	border-color: var(--primary-color);
}

.leaderboard-entry {
	display: flex;
	align-items: center;
	gap: 1rem;
	padding: 1rem;
	background: var(--card-bg);
	border: 2px solid var(--accent-lightest);
	margin-bottom: 0.75rem;
}

.leaderboard-rank {
	font-size: 1.5rem;
	font-weight: bold;
	min-width: 50px;
	text-align: center;
	color: var(--primary-color);
}

.leaderboard-rank.gold { color: #b8860b; }
.leaderboard-rank.silver { color: #708090; }
.leaderboard-rank.bronze { color: #8b4513; }

.leaderboard-info {
	flex: 1;
	text-align: left;
}

.leaderboard-score {
	font-size: 1.25rem;
	font-weight: bold;
	color: var(--primary-color);
}

.leaderboard-details {
	font-size: 0.9rem;
	color: var(--secondary-color);
	margin-top: 0.25rem;
}

/* ============================================
   LAYOUT - Achievements
   ============================================ */

.achievement-grid {
	display: grid;
	grid-template-columns: (2, 1fr);
	gap: 1rem;
}

.achievement-card {
	display: flex;
	align-items: center;
	gap: 1rem;
	padding: 1rem;
	background: var(--card-bg);
	border: 2px solid var(--accent-lightest);
	transition: all 0.3s ease;
}

.achievement-card.locked {
	opacity: 0.5;
	filter: grayscale(100%);
}

.achievement-card.unlocked {
	background: rgba(76, 175, 80, 0.2);
	border-color: rgba(76, 175, 80, 0.4);
}

.achievement-icon {
	font-size: 2.5rem;
}

.achievement-info {
	flex: 1;
	text-align: left;
}

.achievement-name {
	font-weight: bold;
	font-size: 1.1rem;
	color: var(--primary-color);
}

.achievement-desc {
	font-size: 0.9rem;
	color: var(--secondary-color);
	margin-top: 0.25rem;
}

.achievement-status {
	font-size: 0.8rem;
	color: #4caf50;
	font-weight: 600;
	margin-top: 0.25rem;
}

/* ============================================
   LAYOUT - Settings & Selectors
   ============================================ */

.section-selector {
	margin: 1.5rem 0;
	padding: 1.5rem;
	background: var(--card-bg);
	border: 2px solid var(--card-border);
}

.section-option, .time-limit-select {
	width: 100%;
	padding: 0.75rem;
	border: 2px solid var(--card-border);
	background: var(--card-bg);
	font-family: var(--font-family);
	font-size: 1rem;
	color: var(--primary-color);
	margin-bottom: 0.5rem;
}

.time-limit-label {
	display: block;
	margin-bottom: 0.5rem;
	font-weight: 600;
	color: var(--primary-color);
	text-transform: uppercase;
	letter-spacing: 0.1rem;
	font-size: 0.9rem;
}

.section-start-btn {
	width: 100%;
	margin-top: 1rem;
}

/* Category tabs for Seion/Dakuon/Y≈çon */
.category-tabs {
	display: flex;
	gap: 0.5rem;
	margin: 0.5rem 0 1rem 0;
}

.category-tab {
	flex: 1;
	padding: 0.75rem 0.5rem;
	font-size: 0.9rem;
	text-align: center;
	line-height: 1.3;
	min-height: auto;
}

.category-tab small {
	font-size: 0.7rem;
	opacity: 0.8;
}

.category-tab.active {
	background-color: transparent;
	color: var(--light-text);
	border-color: var(--primary-color);
}

.category-tab.active::before {
	width: 100%;
}

.settings-group {
	display: flex;
	flex-direction: column;
	gap: 1.5rem;
	margin: 2rem 0;
}

.setting-item {
	display: flex;
	flex-direction: column;
	gap: 0.5rem;
}

.setting-label {
	font-weight: 600;
	font-size: 1.1rem;
	color: var(--primary-color);
}

.setting-select {
	width: 100%;
	padding: 1rem;
	border: 2px solid var(--card-border);
	background: var(--card-bg);
	font-family: var(--font-family);
	font-size: 1rem;
	color: var(--primary-color);
	cursor: pointer;
	transition: all 0.3s ease;
}

.setting-select:hover,
.setting-select:focus {
	outline: none;
	border-color: var(--primary-color);
	box-shadow: 3px 3px 0 var(--card-shadow);
}

/* ============================================
   LAYOUT - Background Decorations
   ============================================ */

.circle {
	position: fixed;
	border: 2px solid var(--accent-lightest);
	border-radius: 100%;
	pointer-events: none;
	z-index: 0;
}

.circle-1 {
	width: 700px;
	height: 700px;
	top: -350px;
	left: -150px;
	animation: float-1 20s ease-in-out infinite;
}

.circle-2 {
	width: 675px;
	height: 675px;
	top: -350px;
	left: -150px;
	animation: float-1 20s ease-in-out infinite;
}

.circle-3 {
	width: 750px;
	height: 750px;
	bottom: -300px;
	right: -250px;
	animation: float-2 25s ease-in-out infinite;
}

.circle-4 {
	width: 725px;
	height: 725px;
	bottom: -300px;
	right: -250px;
	animation: float-2 25s ease-in-out infinite;
}

.line {
	position: absolute;
	width: 2px;
	background: var(--accent-light);
	pointer-events: none;
}

.line-1 {
	height: 50%;
	top: -25%;
	left: 20%;
	transform: rotate(-35deg);
	animation: slide-diagonal 15s ease-in-out infinite;
}

.line-2 {
	height: 45%;
	top: -20%;
	left: 15%;
	transform: rotate(-35deg);
	animation: slide-diagonal 15s ease-in-out infinite;
}

.line-3 {
	height: 55%;
	top: -15%;
	left: 10%;
	transform: rotate(35deg);
	animation: slide-diagonal 20s ease-in-out infinite reverse;
}

.line-4 {
	height: 50%;
	bottom: -25%;
	right: 20%;
	transform: rotate(-35deg);
	animation: slide-diagonal-reverse 15s ease-in-out infinite;
}

.line-5 {
	height: 45%;
	bottom: -20%;
	right: 15%;
	transform: rotate(-35deg);
	animation: slide-diagonal-reverse 15s ease-in-out infinite;
}

.line-6 {
	height: 55%;
	bottom: -15%;
	right: 10%;
	transform: rotate(35deg);
	animation: slide-diagonal-reverse 20s ease-in-out infinite reverse;
}

/* ============================================
   LAYOUT - Stars (Midnight Theme Only)
   ============================================ */

.stars-container {
	position: fixed;
	top: 0;
	left: 0;
	width: 100%;
	height: 100%;
	pointer-events: none;
	z-index: 0;
	overflow: hidden;
	display: none;
}

body.midnight-theme .stars-container {
	display: block;
}

.star {
	position: absolute;
	background: #ffffff;
	border-radius: 50%;
	animation: twinkle var(--twinkle-duration, 3s) ease-in-out infinite;
	animation-delay: var(--twinkle-delay, 0s);
}

.star.small {
	width: 1px;
	height: 1px;
	box-shadow: 0 0 2px #fff;
}

.star.medium {
	width: 2px;
	height: 2px;
	box-shadow: 0 0 4px #fff, 0 0 8px rgba(123, 104, 238, 0.5);
}

.star.large {
	width: 3px;
	height: 3px;
	box-shadow: 0 0 6px #fff, 0 0 12px rgba(123, 104, 238, 0.7);
}

.shooting-star {
	position: absolute;
	width: 100px;
	height: 2px;
	background: linear-gradient(90deg, rgba(255,255,255,0) 0%, rgba(255,255,255,0.8) 50%, rgba(123,104,238,1) 100%);
	transform: rotate(-45deg);
	animation: shoot 8s ease-in-out infinite;
	opacity: 0;
}

/* ============================================
   LAYOUT - Utility Classes
   ============================================ */

.text-center { text-align: center; }
.text-gray { color: var(--secondary-color); }
.text-xs { font-size: 0.75rem; }
.mb-3 { margin-bottom: 1.5rem; }
.mt-4 { margin-top: 2rem; }

.overflow-auto {
	overflow-y: auto;
	max-height: 500px;
}

/* Confetti canvas */
#confetti-canvas {
	position: fixed;
	top: 0;
	left: 0;
	width: 100%;
	height: 100%;
	pointer-events: none;
	z-index: 9999;
}

/* ============================================
   ANIMATIONS
   ============================================ */

@keyframes fadeIn {
	from { opacity: 0; transform: translateY(-20px); }
	to { opacity: 1; transform: translateY(0); }
}

@keyframes float-1 {
	0%, 100% { transform: translate(0, 0); }
	50% { transform: translate(30px, 40px); }
}

@keyframes float-2 {
	0%, 100% { transform: translate(0, 0); }
	50% { transform: translate(-40px, 30px); }
}

@keyframes slide-diagonal {
	0%, 100% { opacity: 0.1; transform: rotate(-35deg) translateY(0); }
	50% { opacity: 0.2; transform: rotate(-35deg) translateY(50px); }
}

@keyframes slide-diagonal-reverse {
	0%, 100% { opacity: 0.1; transform: rotate(-35deg) translateY(0); }
	50% { opacity: 0.2; transform: rotate(-35deg) translateY(-50px); }
}

@keyframes twinkle {
	0%, 100% { opacity: 0.3; transform: scale(1); }
	50% { opacity: 1; transform: scale(1.2); }
}

@keyframes shoot {
	0% { transform: translateX(0) translateY(0) rotate(-45deg); opacity: 0; }
	2% { opacity: 1; }
	12% { transform: translateX(400px) translateY(400px) rotate(-45deg); opacity: 0; }
	100% { opacity: 0; }
}

@keyframes fall {
	from { transform: translateX(-50%) translateY(-100%); }
	to { transform: translateX(-50%) translateY(400px); }
}

@keyframes correctShake {
	0%, 100% { transform: translateX(0); }
	25% { transform: translateX(-5px) rotate(-2deg); }
	75% { transform: translateX(5px) rotate(2deg); }
}

@keyframes incorrectShake {
	0%, 100% { transform: translateX(0); }
	10%, 30%, 50%, 70%, 90% { transform: translateX(-10px); }
	20%, 40%, 60%, 80% { transform: translateX(10px); }
}

@keyframes kanaDrop {
	0% { top: -100px; opacity: 1; transform: rotate(0deg); }
	70% { opacity: 1; }
	100% { top: calc(100% + 50px); opacity: 0; transform: rotate(360deg); }
}

.kana-display.correct { animation: correctShake 0.4s ease; }
.kana-display.incorrect { animation: incorrectShake 0.5s ease; }

.kana-drop {
	position: absolute;
	top: -100px;
	font-size: 3rem;
	font-weight: bold;
	color: var(--primary-color);
	opacity: 0;
	animation: kanaDrop 2s ease-out forwards;
	pointer-events: none;
	font-family: 'Zen Kurenaido', serif;
}

/* ============================================
   RESPONSIVE - Tablet
   ============================================ */

@media (max-width: 768px) {
	h1 { font-size: 2rem; letter-spacing: 0.3rem; }
	h2 { font-size: 1.5rem; }
	.card { padding: 1.5rem; }
	.container { padding: 0 1rem; }
	.kana-display { font-size: 5rem; min-height: 180px; }
	.answer-grid { grid-template-columns: repeat(2, 1fr); }
	.btn-group { flex-direction: column; }
	.score-details { grid-template-columns: (2, 1fr); }
}

/* ============================================
   RESPONSIVE - Small Mobile
   ============================================ */

@media (max-width: 400px) {
	#app { padding: 0.5rem; }
	.card { padding: 0.75rem; margin: 0.25rem auto; box-shadow: 2px 2px 0 var(--card-shadow); }
	h1 { font-size: 1.5rem; letter-spacing: 0.15rem; margin-bottom: 0.25rem; }
	h2 { font-size: 1.2rem; margin-bottom: 0.75rem; }
	.btn-group { gap: 0.5rem; }
	.btn, button { padding: 0.6rem 1rem; font-size: 0.85rem; }
}

/* ============================================
   RESPONSIVE - Compact Gameplay
   ============================================ */

@media (max-height: 700px) and (max-width: 450px) {
	#app { padding: 0.25rem; }
	.card.large-card { padding: 0.5rem; margin: 0; }
	.stats-bar { padding: 0.4rem; gap: 0.25rem; }
	.stat-label { font-size: 0.6rem; letter-spacing: 0.02rem; }
	.stat-value { font-size: 1rem; }
	.progress-container { margin: 0.35rem 0; }
	.progress-bar { height: 6px; }
	#timer-text { font-size: 0.85rem; margin-bottom: 0.35rem !important; }
	.playing-area { gap: 0.5rem; }
	.kana-display { font-size: 4rem; min-height: 180px; padding: 0.75rem; border-width: 2px; }
	.kana-character { font-size: 5rem; }
	.feedback { font-size: 1rem; bottom: 0.5rem; }
	.ground-line { height: 3px; }
	.answer-grid { grid-template-columns: repeat(2, 1fr); gap: 0.4rem; }
	.answer-button { padding: 0.65rem 0.5rem; font-size: 0.95rem; border-width: 2px; }
	.floating-controls { top: 0.5rem; right: 0.5rem; }
	.floating-btn { padding: 0.3rem 0.6rem; font-size: 0.75rem; }
}

/* ============================================
   RESPONSIVE - Extra Small Height
   ============================================ */

@media (max-height: 580px) {
	.stats-bar { padding: 0.3rem; }
	.stat-label { font-size: 0.5rem; }
	.stat-value { font-size: 0.85rem; }
	.progress-container { margin: 0.2rem 0; }
	#timer-text { font-size: 0.75rem; margin-bottom: 0.2rem !important; }
	.kana-display { font-size: 3.5rem; min-height: 180px; padding: 0.5rem; }
	.kana-character { font-size: 4rem; }
	.answer-button { padding: 0.5rem 0.4rem; font-size: 0.85rem; }
}

/* ============================================
   RESPONSIVE - Touch Devices
   ============================================ */

@media (pointer: coarse) {
	.answer-button { min-height: 44px; }
	.btn, button { min-height: 44px; }
}

/* ============================================
   THEME OVERRIDES - Dawn Minimalist (Default)
   (Full color/visual customizations)
   ============================================ */

.circle {
	border-color: rgba(107, 93, 77, 0.15);
	box-shadow: 0 0 60px rgba(107, 93, 77, 0.1);
}

.line {
	background: linear-gradient(180deg, rgba(107, 93, 77, 0.4) 0%, rgba(74, 64, 53, 0.2) 100%);
}

.card {
	background: rgba(255, 252, 247, 0.85);
	border-color: rgba(107, 93, 77, 0.3);
	box-shadow: 0 0 30px rgba(107, 93, 77, 0.1), 5px 5px 0 rgba(107, 93, 77, 0.15);
}

h1 {
	text-shadow: 0 0 20px rgba(107, 93, 77, 0.2), 0.3rem 0.3rem 0 rgba(107, 93, 77, 0.15);
}

.btn, 
button {
	background-color: rgba(107, 93, 77, 0.2);
	color: var(--primary-color);
	border-color: rgba(107, 93, 77, 0.3);
}

.btn::before, 
button::before {
	background: linear-gradient(90deg, #8B7355, #A68B5B);
}

.btn:hover, 
button:hover {
	border-color: #8B7355;
	box-shadow: 0 0 15px rgba(139, 115, 85, 0.3);
}

.stats-bar {
	background: rgba(107, 93, 77, 0.1);
	border-color: rgba(107, 93, 77, 0.25);
}

.kana-display {
	background: rgba(255, 252, 247, 0.7);
	border-color: rgba(107, 93, 77, 0.3);
	box-shadow: 0 0 40px rgba(107, 93, 77, 0.1), inset 0 0 30px rgba(107, 93, 77, 0.05);
}

.answer-button {
	background: rgba(255, 252, 247, 0.6);
	border-color: rgba(107, 93, 77, 0.25);
}

.answer-button:hover {
	border-color: #8B7355;
	box-shadow: 0 0 15px rgba(139, 115, 85, 0.3);
}

.answer-button.correct {
	background: rgba(92, 122, 61, 0.2);
	border-color: #8BA86A;
	color: #5C7A3D;
	box-shadow: 0 0 20px rgba(139, 168, 106, 0.3), inset 0 0 15px rgba(139, 168, 106, 0.1);
}

.answer-button.incorrect {
	background: rgba(180, 100, 90, 0.2);
	border-color: #B4645A;
	color: #8B4840;
	box-shadow: 0 0 20px rgba(180, 100, 90, 0.3), inset 0 0 15px rgba(180, 100, 90, 0.1);
}

.progress-bar {
	background: rgba(107, 93, 77, 0.1);
	border-color: rgba(107, 93, 77, 0.25);
}

.progress-fill {
	background: linear-gradient(90deg, #8B7355, #A68B5B);
}

.progress-fill.green {
	background: linear-gradient(90deg, #7a9e5a, #8BA86A);
}

.tab {
	background: rgba(107, 93, 77, 0.1);
	border-color: rgba(107, 93, 77, 0.25);
}

.tab:hover {
	background: rgba(107, 93, 77, 0.2);
}

.tab.active {
	background: linear-gradient(135deg, #8B7355, #A68B5B);
	border-color: #8B7355;
	color: #FFF8F0;
}

.leaderboard-entry,
.achievement-card {
	background: rgba(255, 252, 247, 0.6);
	border-color: rgba(107, 93, 77, 0.15);
}

.achievement-card.unlocked {
	background: rgba(139, 168, 106, 0.15);
	border-color: rgba(139, 168, 106, 0.4);
}

.section-selector {
	background: rgba(255, 252, 247, 0.5);
	border-color: rgba(107, 93, 77, 0.25);
}

.section-option,
.time-limit-select {
	background: rgba(255, 252, 247, 0.8);
	border-color: rgba(107, 93, 77, 0.25);
	color: var(--primary-color);
}

.setting-select {
	background: rgba(255, 252, 247, 0.8);
	border-color: rgba(107, 93, 77, 0.25);
	color: var(--primary-color);
}

.setting-select:hover,
.setting-select:focus {
	border-color: #8B7355;
	box-shadow: 0 0 15px rgba(139, 115, 85, 0.2);
}

.new-record-badge {
	background: linear-gradient(135deg, #8B7355, #A68B5B);
	border-color: #8B7355;
	color: #FFF8F0;
	box-shadow: 0 0 25px rgba(139, 115, 85, 0.4);
}

.score-item {
	background: rgba(107, 93, 77, 0.1);
	border-color: rgba(107, 93, 77, 0.2);
}

blockquote:before {
	border-color: rgba(107, 93, 77, 0.4);
}

.ground-line {
	background: linear-gradient(90deg, #B4645A, #C8847A);
	box-shadow: 0 0 10px rgba(180, 100, 90, 0.4);
}

.feedback.correct {
	color: #5C7A3D;
	text-shadow: 0 0 10px rgba(92, 122, 61, 0.4);
}

.feedback.incorrect {
	color: #8B4840;
	text-shadow: 0 0 10px rgba(139, 72, 64, 0.4);
}

/* ============================================
   THEME OVERRIDES - Midnight Sky
   (Full color/visual customizations)
   ============================================ */

body.midnight-theme .circle {
	border-color: rgba(123, 104, 238, 0.15);
	box-shadow: 0 0 60px rgba(123, 104, 238, 0.1);
}

body.midnight-theme .line {
	background: linear-gradient(180deg, rgba(123, 104, 238, 0.4) 0%, rgba(75, 0, 130, 0.2) 100%);
}

body.midnight-theme .card {
	background: rgba(20, 25, 50, 0.85);
	border-color: rgba(123, 104, 238, 0.3);
	box-shadow: 0 0 30px rgba(123, 104, 238, 0.15), 5px 5px 0 rgba(0, 0, 0, 0.3);
	backdrop-filter: blur(10px);
}

body.midnight-theme h1 {
	text-shadow: 0 0 20px rgba(123, 104, 238, 0.5), 0.3rem 0.3rem 0 rgba(0, 0, 0, 0.3);
}

body.midnight-theme .btn, 
body.midnight-theme button {
	background-color: rgba(123, 104, 238, 0.25);
	color: var(--primary-color);
	border-color: rgba(123, 104, 238, 0.4);
}

body.midnight-theme .btn::before, 
body.midnight-theme button::before {
	background: linear-gradient(90deg, #7B68EE, #9370DB);
}

body.midnight-theme .btn:hover, 
body.midnight-theme button:hover {
	border-color: #7B68EE;
	box-shadow: 0 0 15px rgba(123, 104, 238, 0.4);
}

body.midnight-theme .stats-bar {
	background: rgba(123, 104, 238, 0.15);
	border-color: rgba(123, 104, 238, 0.3);
}

body.midnight-theme .kana-display {
	background: rgba(30, 35, 70, 0.6);
	border-color: rgba(123, 104, 238, 0.4);
	box-shadow: 0 0 40px rgba(123, 104, 238, 0.2), inset 0 0 30px rgba(123, 104, 238, 0.1);
}

body.midnight-theme .answer-button {
	background: rgba(30, 35, 70, 0.5);
	border-color: rgba(123, 104, 238, 0.3);
}

body.midnight-theme .answer-button:hover {
	border-color: #7B68EE;
	box-shadow: 0 0 15px rgba(123, 104, 238, 0.4);
}

body.midnight-theme .answer-button.correct {
	background: rgba(100, 220, 150, 0.25);
	border-color: #64DC96;
	color: #90EEB8;
	box-shadow: 0 0 20px rgba(100, 220, 150, 0.4), inset 0 0 15px rgba(100, 220, 150, 0.1);
}

body.midnight-theme .answer-button.incorrect {
	background: rgba(255, 100, 130, 0.25);
	border-color: #FF6482;
	color: #FF8FA8;
	box-shadow: 0 0 20px rgba(255, 100, 130, 0.4), inset 0 0 15px rgba(255, 100, 130, 0.1);
}

body.midnight-theme .progress-bar {
	background: rgba(123, 104, 238, 0.15);
	border-color: rgba(123, 104, 238, 0.3);
}

body.midnight-theme .progress-fill {
	background: linear-gradient(90deg, #7B68EE, #9370DB);
}

body.midnight-theme .progress-fill.green {
	background: linear-gradient(90deg, #4caf50, #66bb6a);
}

body.midnight-theme .tab {
	background: rgba(123, 104, 238, 0.15);
	border-color: rgba(123, 104, 238, 0.3);
}

body.midnight-theme .tab:hover {
	background: rgba(123, 104, 238, 0.25);
}

body.midnight-theme .tab.active {
	background: linear-gradient(135deg, #7B68EE, #9370DB);
	border-color: #7B68EE;
}

body.midnight-theme .leaderboard-entry,
body.midnight-theme .achievement-card {
	background: rgba(30, 35, 70, 0.5);
	border-color: rgba(123, 104, 238, 0.2);
}

body.midnight-theme .achievement-card.unlocked {
	background: rgba(76, 175, 80, 0.15);
	border-color: rgba(76, 175, 80, 0.4);
}

body.midnight-theme .section-selector {
	background: rgba(30, 35, 70, 0.4);
	border-color: rgba(123, 104, 238, 0.3);
}

body.midnight-theme .section-option,
body.midnight-theme .time-limit-select {
	background: rgba(20, 25, 50, 0.8);
	border-color: rgba(123, 104, 238, 0.3);
	color: var(--primary-color);
}

body.midnight-theme .setting-select {
	background: rgba(20, 25, 50, 0.8);
	border-color: rgba(123, 104, 238, 0.3);
	color: var(--primary-color);
}

body.midnight-theme .setting-select:hover,
body.midnight-theme .setting-select:focus {
	border-color: #7B68EE;
	box-shadow: 0 0 15px rgba(123, 104, 238, 0.3);
}

body.midnight-theme .new-record-badge {
	background: linear-gradient(135deg, #7B68EE, #9370DB);
	border-color: #7B68EE;
	box-shadow: 0 0 25px rgba(123, 104, 238, 0.5);
}

body.midnight-theme .score-item {
	background: rgba(123, 104, 238, 0.15);
	border-color: rgba(123, 104, 238, 0.3);
}

body.midnight-theme blockquote:before {
	border-color: rgba(123, 104, 238, 0.4);
}

body.midnight-theme .ground-line {
	background: linear-gradient(90deg, #FF6482, #FF8FA8);
	box-shadow: 0 0 10px rgba(255, 100, 130, 0.5);
}

body.midnight-theme .feedback.correct {
	color: #64DC96;
	text-shadow: 0 0 10px rgba(100, 220, 150, 0.5);
}

body.midnight-theme .feedback.incorrect {
	color: #FF6482;
	text-shadow: 0 0 10px rgba(255, 100, 130, 0.5);
}

</style>
</head>
<body>
	<!-- Stars background for midnight theme -->
	<div class="stars-container" id="starsContainer"></div>

	<!-- Background decorative elements -->
	<div class="circle circle-1"></div>
	<div class="circle circle-2"></div>
	<div class="circle circle-3"></div>
	<div class="circle circle-4"></div>
	<div class="line line-1"></div>
	<div class="line line-2"></div>
	<div class="line line-3"></div>
	<div class="line line-4"></div>
	<div class="line line-5"></div>
	<div class="line line-6"></div>

	<div id="app"></div>
	<canvas id="confetti-canvas"></canvas>
</file_text>		<script>
		// ===== GAME STATE =====
		const state = {
			gameState: 'menu',
			kanaType: 'hiragana',
			difficulty: 'easy',
			kanaSection: 'vowels',
			sectionTimeLimit: null,
			
			currentChar: null,
			correctAnswer: '',
			options: [],
			randomFont: "'Yomogi', cursive",
			previousChar: null,
			previousFont: null,
			
			score: 0,
			streak: 0,
			bestStreak: 0,
			roundsPlayed: 0,
			correctCount: 0,
			incorrectCount: 0,
			
			startTime: null,
			roundStartTime: null,
			totalTime: 0,
			timeLeft: 0,
			
			statsTab: 'leaderboard',
			
			isNewRecord: false,
			
			unlockedAchievements: [],
			totalRoundsPlayed: 0,
			hiraganaRoundsPlayed: 0,
			katakanaRoundsPlayed: 0,
			hardModeRounds: 0,
			hasPlayedHiragana: false,
			hasPlayedKatakana: false,
			
			timeRemaining: null,
			timerInterval: null,
			
			audioEnabled: true
		};

		// ===== KANA DATA =====
		const DIFFICULTY = {
			easy: { time: 5.0 },
			medium: { time: 3.5 },
			hard: { time: 2.0 }
		};

		const HIRAGANA = {
			vowels: [
				{ char: '„ÅÇ', romaji: 'a' },
				{ char: '„ÅÑ', romaji: 'i' },
				{ char: '„ÅÜ', romaji: 'u' },
				{ char: '„Åà', romaji: 'e' },
				{ char: '„Åä', romaji: 'o' }
			],
			k_row: [
				{ char: '„Åã', romaji: 'ka' },
				{ char: '„Åç', romaji: 'ki' },
				{ char: '„Åè', romaji: 'ku' },
				{ char: '„Åë', romaji: 'ke' },
				{ char: '„Åì', romaji: 'ko' }
			],
			s_row: [
				{ char: '„Åï', romaji: 'sa' },
				{ char: '„Åó', romaji: 'shi' },
				{ char: '„Åô', romaji: 'su' },
				{ char: '„Åõ', romaji: 'se' },
				{ char: '„Åù', romaji: 'so' }
			],
			t_row: [
				{ char: '„Åü', romaji: 'ta' },
				{ char: '„Å°', romaji: 'chi' },
				{ char: '„Å§', romaji: 'tsu' },
				{ char: '„Å¶', romaji: 'te' },
				{ char: '„Å®', romaji: 'to' }
			],
			n_row: [
				{ char: '„Å™', romaji: 'na' },
				{ char: '„Å´', romaji: 'ni' },
				{ char: '„Å¨', romaji: 'nu' },
				{ char: '„Å≠', romaji: 'ne' },
				{ char: '„ÅÆ', romaji: 'no' }
			],
			h_row: [
				{ char: '„ÅØ', romaji: 'ha' },
				{ char: '„Å≤', romaji: 'hi' },
				{ char: '„Åµ', romaji: 'fu' },
				{ char: '„Å∏', romaji: 'he' },
				{ char: '„Åª', romaji: 'ho' }
			],
			m_row: [
				{ char: '„Åæ', romaji: 'ma' },
				{ char: '„Åø', romaji: 'mi' },
				{ char: '„ÇÄ', romaji: 'mu' },
				{ char: '„ÇÅ', romaji: 'me' },
				{ char: '„ÇÇ', romaji: 'mo' }
			],
			y_row: [
				{ char: '„ÇÑ', romaji: 'ya' },
				{ char: '„ÇÜ', romaji: 'yu' },
				{ char: '„Çà', romaji: 'yo' }
			],
			r_row: [
				{ char: '„Çâ', romaji: 'ra' },
				{ char: '„Çä', romaji: 'ri' },
				{ char: '„Çã', romaji: 'ru' },
				{ char: '„Çå', romaji: 're' },
				{ char: '„Çç', romaji: 'ro' }
			],
			w_row: [
				{ char: '„Çè', romaji: 'wa' },
				{ char: '„Çí', romaji: 'wo' },
				{ char: '„Çì', romaji: 'n' }
			],
			g_row: [
				{ char: '„Åå', romaji: 'ga' },
				{ char: '„Åé', romaji: 'gi' },
				{ char: '„Åê', romaji: 'gu' },
				{ char: '„Åí', romaji: 'ge' },
				{ char: '„Åî', romaji: 'go' }
			],
			z_row: [
				{ char: '„Åñ', romaji: 'za' },
				{ char: '„Åò', romaji: 'ji' },
				{ char: '„Åö', romaji: 'zu' },
				{ char: '„Åú', romaji: 'ze' },
				{ char: '„Åû', romaji: 'zo' }
			],
			d_row: [
				{ char: '„Å†', romaji: 'da' },
				{ char: '„Å¢', romaji: 'ji' },
				{ char: '„Å•', romaji: 'zu' },
				{ char: '„Åß', romaji: 'de' },
				{ char: '„Å©', romaji: 'do' }
			],
			b_row: [
				{ char: '„Å∞', romaji: 'ba' },
				{ char: '„Å≥', romaji: 'bi' },
				{ char: '„Å∂', romaji: 'bu' },
				{ char: '„Åπ', romaji: 'be' },
				{ char: '„Åº', romaji: 'bo' }
			],
			p_row: [
				{ char: '„Å±', romaji: 'pa' },
				{ char: '„Å¥', romaji: 'pi' },
				{ char: '„Å∑', romaji: 'pu' },
				{ char: '„Å∫', romaji: 'pe' },
				{ char: '„ÅΩ', romaji: 'po' }
			],
			ky_yoon: [
				{ char: '„Åç„ÇÉ', romaji: 'kya' },
				{ char: '„Åç„ÇÖ', romaji: 'kyu' },
				{ char: '„Åç„Çá', romaji: 'kyo' }
			],
			sh_yoon: [
				{ char: '„Åó„ÇÉ', romaji: 'sha' },
				{ char: '„Åó„ÇÖ', romaji: 'shu' },
				{ char: '„Åó„Çá', romaji: 'sho' }
			],
			ch_yoon: [
				{ char: '„Å°„ÇÉ', romaji: 'cha' },
				{ char: '„Å°„ÇÖ', romaji: 'chu' },
				{ char: '„Å°„Çá', romaji: 'cho' }
			],
			ny_yoon: [
				{ char: '„Å´„ÇÉ', romaji: 'nya' },
				{ char: '„Å´„ÇÖ', romaji: 'nyu' },
				{ char: '„Å´„Çá', romaji: 'nyo' }
			],
			hy_yoon: [
				{ char: '„Å≤„ÇÉ', romaji: 'hya' },
				{ char: '„Å≤„ÇÖ', romaji: 'hyu' },
				{ char: '„Å≤„Çá', romaji: 'hyo' }
			],
			my_yoon: [
				{ char: '„Åø„ÇÉ', romaji: 'mya' },
				{ char: '„Åø„ÇÖ', romaji: 'myu' },
				{ char: '„Åø„Çá', romaji: 'myo' }
			],
			ry_yoon: [
				{ char: '„Çä„ÇÉ', romaji: 'rya' },
				{ char: '„Çä„ÇÖ', romaji: 'ryu' },
				{ char: '„Çä„Çá', romaji: 'ryo' }
			],
			gy_yoon: [
				{ char: '„Åé„ÇÉ', romaji: 'gya' },
				{ char: '„Åé„ÇÖ', romaji: 'gyu' },
				{ char: '„Åé„Çá', romaji: 'gyo' }
			],
			j_yoon: [
				{ char: '„Åò„ÇÉ', romaji: 'ja' },
				{ char: '„Åò„ÇÖ', romaji: 'ju' },
				{ char: '„Åò„Çá', romaji: 'jo' }
			],
			by_yoon: [
				{ char: '„Å≥„ÇÉ', romaji: 'bya' },
				{ char: '„Å≥„ÇÖ', romaji: 'byu' },
				{ char: '„Å≥„Çá', romaji: 'byo' }
			],
			py_yoon: [
				{ char: '„Å¥„ÇÉ', romaji: 'pya' },
				{ char: '„Å¥„ÇÖ', romaji: 'pyu' },
				{ char: '„Å¥„Çá', romaji: 'pyo' }
			]
		};

		const KATAKANA = {
			vowels: [
				{ char: '„Ç¢', romaji: 'a' },
				{ char: '„Ç§', romaji: 'i' },
				{ char: '„Ç¶', romaji: 'u' },
				{ char: '„Ç®', romaji: 'e' },
				{ char: '„Ç™', romaji: 'o' }
			],
			k_row: [
				{ char: '„Ç´', romaji: 'ka' },
				{ char: '„Ç≠', romaji: 'ki' },
				{ char: '„ÇØ', romaji: 'ku' },
				{ char: '„Ç±', romaji: 'ke' },
				{ char: '„Ç≥', romaji: 'ko' }
			],
			s_row: [
				{ char: '„Çµ', romaji: 'sa' },
				{ char: '„Ç∑', romaji: 'shi' },
				{ char: '„Çπ', romaji: 'su' },
				{ char: '„Çª', romaji: 'se' },
				{ char: '„ÇΩ', romaji: 'so' }
			],
			t_row: [
				{ char: '„Çø', romaji: 'ta' },
				{ char: '„ÉÅ', romaji: 'chi' },
				{ char: '„ÉÑ', romaji: 'tsu' },
				{ char: '„ÉÜ', romaji: 'te' },
				{ char: '„Éà', romaji: 'to' }
			],
			n_row: [
				{ char: '„Éä', romaji: 'na' },
				{ char: '„Éã', romaji: 'ni' },
				{ char: '„Éå', romaji: 'nu' },
				{ char: '„Éç', romaji: 'ne' },
				{ char: '„Éé', romaji: 'no' }
			],
			h_row: [
				{ char: '„Éè', romaji: 'ha' },
				{ char: '„Éí', romaji: 'hi' },
				{ char: '„Éï', romaji: 'fu' },
				{ char: '„Éò', romaji: 'he' },
				{ char: '„Éõ', romaji: 'ho' }
			],
			m_row: [
				{ char: '„Éû', romaji: 'ma' },
				{ char: '„Éü', romaji: 'mi' },
				{ char: '„É†', romaji: 'mu' },
				{ char: '„É°', romaji: 'me' },
				{ char: '„É¢', romaji: 'mo' }
			],
			y_row: [
				{ char: '„É§', romaji: 'ya' },
				{ char: '„É¶', romaji: 'yu' },
				{ char: '„É®', romaji: 'yo' }
			],
			r_row: [
				{ char: '„É©', romaji: 'ra' },
				{ char: '„É™', romaji: 'ri' },
				{ char: '„É´', romaji: 'ru' },
				{ char: '„É¨', romaji: 're' },
				{ char: '„É≠', romaji: 'ro' }
			],
			w_row: [
				{ char: '„ÉØ', romaji: 'wa' },
				{ char: '„É≤', romaji: 'wo' },
				{ char: '„É≥', romaji: 'n' }
			],
			g_row: [
				{ char: '„Ç¨', romaji: 'ga' },
				{ char: '„ÇÆ', romaji: 'gi' },
				{ char: '„Ç∞', romaji: 'gu' },
				{ char: '„Ç≤', romaji: 'ge' },
				{ char: '„Ç¥', romaji: 'go' }
			],
			z_row: [
				{ char: '„Ç∂', romaji: 'za' },
				{ char: '„Ç∏', romaji: 'ji' },
				{ char: '„Ç∫', romaji: 'zu' },
				{ char: '„Çº', romaji: 'ze' },
				{ char: '„Çæ', romaji: 'zo' }
			],
			d_row: [
				{ char: '„ÉÄ', romaji: 'da' },
				{ char: '„ÉÇ', romaji: 'ji' },
				{ char: '„ÉÖ', romaji: 'zu' },
				{ char: '„Éá', romaji: 'de' },
				{ char: '„Éâ', romaji: 'do' }
			],
			b_row: [
				{ char: '„Éê', romaji: 'ba' },
				{ char: '„Éì', romaji: 'bi' },
				{ char: '„Éñ', romaji: 'bu' },
				{ char: '„Éô', romaji: 'be' },
				{ char: '„Éú', romaji: 'bo' }
			],
			p_row: [
				{ char: '„Éë', romaji: 'pa' },
				{ char: '„Éî', romaji: 'pi' },
				{ char: '„Éó', romaji: 'pu' },
				{ char: '„Éö', romaji: 'pe' },
				{ char: '„Éù', romaji: 'po' }
			],
			ky_yoon: [
				{ char: '„Ç≠„É£', romaji: 'kya' },
				{ char: '„Ç≠„É•', romaji: 'kyu' },
				{ char: '„Ç≠„Éß', romaji: 'kyo' }
			],
			sh_yoon: [
				{ char: '„Ç∑„É£', romaji: 'sha' },
				{ char: '„Ç∑„É•', romaji: 'shu' },
				{ char: '„Ç∑„Éß', romaji: 'sho' }
			],
			ch_yoon: [
				{ char: '„ÉÅ„É£', romaji: 'cha' },
				{ char: '„ÉÅ„É•', romaji: 'chu' },
				{ char: '„ÉÅ„Éß', romaji: 'cho' }
			],
			ny_yoon: [
				{ char: '„Éã„É£', romaji: 'nya' },
				{ char: '„Éã„É•', romaji: 'nyu' },
				{ char: '„Éã„Éß', romaji: 'nyo' }
			],
			hy_yoon: [
				{ char: '„Éí„É£', romaji: 'hya' },
				{ char: '„Éí„É•', romaji: 'hyu' },
				{ char: '„Éí„Éß', romaji: 'hyo' }
			],
			my_yoon: [
				{ char: '„Éü„É£', romaji: 'mya' },
				{ char: '„Éü„É•', romaji: 'myu' },
				{ char: '„Éü„Éß', romaji: 'myo' }
			],
			ry_yoon: [
				{ char: '„É™„É£', romaji: 'rya' },
				{ char: '„É™„É•', romaji: 'ryu' },
				{ char: '„É™„Éß', romaji: 'ryo' }
			],
			gy_yoon: [
				{ char: '„ÇÆ„É£', romaji: 'gya' },
				{ char: '„ÇÆ„É•', romaji: 'gyu' },
				{ char: '„ÇÆ„Éß', romaji: 'gyo' }
			],
			j_yoon: [
				{ char: '„Ç∏„É£', romaji: 'ja' },
				{ char: '„Ç∏„É•', romaji: 'ju' },
				{ char: '„Ç∏„Éß', romaji: 'jo' }
			],
			by_yoon: [
				{ char: '„Éì„É£', romaji: 'bya' },
				{ char: '„Éì„É•', romaji: 'byu' },
				{ char: '„Éì„Éß', romaji: 'byo' }
			],
			py_yoon: [
				{ char: '„Éî„É£', romaji: 'pya' },
				{ char: '„Éî„É•', romaji: 'pyu' },
				{ char: '„Éî„Éß', romaji: 'pyo' }
			]
		};

		// ===== ACHIEVEMENTS =====
		const ACHIEVEMENTS = {
			first_steps: {
				id: 'first_steps',
				name: 'üéØ First Steps',
				desc: 'Complete your first round',
				icon: 'üë£'
			},
			dedication: {
				id: 'dedication',
				name: 'üí™ Dedication',
				desc: 'Play 10 rounds',
				icon: 'üî•'
			},
			veteran: {
				id: 'veteran',
				name: 'üèÜ Veteran',
				desc: 'Play 50 rounds',
				icon: '‚≠ê'
			},
			master: {
				id: 'master',
				name: 'üëë Master',
				desc: 'Play 100 rounds',
				icon: 'üéì'
			},
			streak_5: {
				id: 'streak_5',
				name: 'üî• Hot Streak',
				desc: 'Get a 5 answer streak',
				icon: 'üåü'
			},
			streak_10: {
				id: 'streak_10',
				name: '‚ö° Lightning Round',
				desc: 'Get a 10 answer streak',
				icon: '‚ö°'
			},
			streak_20: {
				id: 'streak_20',
				name: 'üå™Ô∏è Unstoppable',
				desc: 'Get a 20 answer streak',
				icon: 'üí´'
			},
			hiragana_hero: {
				id: 'hiragana_hero',
				name: 'üå∏ Hiragana Hero',
				desc: 'Play 10 Hiragana rounds',
				icon: 'üáØüáµ'
			},
			katakana_king: {
				id: 'katakana_king',
				name: '‚öîÔ∏è Katakana King',
				desc: 'Play 10 Katakana rounds',
				icon: 'üëë'
			},
			both_scripts: {
				id: 'both_scripts',
				name: 'üé≠ Bilingual',
				desc: 'Play both Hiragana and Katakana',
				icon: 'üåè'
			},
			hard_mode: {
				id: 'hard_mode',
				name: 'üíÄ Hard Mode',
				desc: 'Complete 5 rounds on Hard difficulty',
				icon: 'üî•'
			},
			speed_demon: {
				id: 'speed_demon',
				name: '‚ö° Speed Demon',
				desc: 'Average under 2 seconds per answer',
				icon: 'üèÉ'
			}
		};

		// ===== AUDIO =====
		function playSound(type) {
			if (!state.audioEnabled) return;
			
			const audioContext = new (window.AudioContext || window.webkitAudioContext)();
			const oscillator = audioContext.createOscillator();
			const gainNode = audioContext.createGain();
			
			oscillator.connect(gainNode);
			gainNode.connect(audioContext.destination);
			
			if (type === 'correct') {
				oscillator.frequency.setValueAtTime(523.25, audioContext.currentTime); // C5
				oscillator.frequency.setValueAtTime(659.25, audioContext.currentTime + 0.1); // E5
				oscillator.frequency.setValueAtTime(783.99, audioContext.currentTime + 0.2); // G5
				gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
				gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
				oscillator.start(audioContext.currentTime);
				oscillator.stop(audioContext.currentTime + 0.3);
			} else if (type === 'incorrect') {
				oscillator.frequency.setValueAtTime(200, audioContext.currentTime);
				oscillator.frequency.setValueAtTime(150, audioContext.currentTime + 0.1);
				gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
				gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.2);
				oscillator.start(audioContext.currentTime);
				oscillator.stop(audioContext.currentTime + 0.2);
			} else if (type === 'achievement') {
				oscillator.frequency.setValueAtTime(523.25, audioContext.currentTime);
				oscillator.frequency.setValueAtTime(659.25, audioContext.currentTime + 0.15);
				oscillator.frequency.setValueAtTime(783.99, audioContext.currentTime + 0.3);
				oscillator.frequency.setValueAtTime(1046.50, audioContext.currentTime + 0.45);
				gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
				gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.6);
				oscillator.start(audioContext.currentTime);
				oscillator.stop(audioContext.currentTime + 0.6);
			}
		}

		function loadAudioPreference() {
			const saved = localStorage.getItem('kanaBlitzAudio');
			if (saved !== null) {
				state.audioEnabled = saved === 'true';
			}
		}

		// ===== THEME FUNCTIONS =====
		function createStars() {
			const container = document.getElementById('starsContainer');
			if (!container) return;
			
			container.innerHTML = '';
			
			// Create random stars
			const starCount = 150;
			for (let i = 0; i < starCount; i++) {
				const star = document.createElement('div');
				star.className = 'star';
				
				// Random size class
				const sizeRand = Math.random();
				if (sizeRand < 0.6) star.classList.add('small');
				else if (sizeRand < 0.9) star.classList.add('medium');
				else star.classList.add('large');
				
				// Random position
				star.style.left = Math.random() * 100 + '%';
				star.style.top = Math.random() * 100 + '%';
				
				// Random twinkle timing
				star.style.setProperty('--twinkle-duration', (2 + Math.random() * 4) + 's');
				star.style.setProperty('--twinkle-delay', (Math.random() * 5) + 's');
				
				container.appendChild(star);
			}
			
			// Create shooting stars
			for (let i = 0; i < 3; i++) {
				const shootingStar = document.createElement('div');
				shootingStar.className = 'shooting-star';
				shootingStar.style.left = (10 + Math.random() * 40) + '%';
				shootingStar.style.top = (5 + Math.random() * 30) + '%';
				shootingStar.style.animationDelay = (i * 4 + Math.random() * 2) + 's';
				container.appendChild(shootingStar);
			}
		}

		function loadThemePreference() {
			const saved = localStorage.getItem('kanaBlitzTheme');
			
			if (saved === 'midnight') {
				document.body.classList.add('midnight-theme');
				createStars();
			}
			// dawn is the default, no class needed
		}

		// ===== GAME LOGIC =====
		function getKanaSet() {
			// Comprehensive challenge mode - combine both scripts
			if (state.kanaType === 'comprehensive') {
				const allHiragana = Object.values(HIRAGANA).flat();
				const allKatakana = Object.values(KATAKANA).flat();
				return [...allHiragana, ...allKatakana];
			}
			
			const kanaData = state.kanaType === 'hiragana' ? HIRAGANA : KATAKANA;
			
			// Handle 'all' section - return all kana of selected type
			if (state.kanaSection === 'all') {
				return Object.values(kanaData).flat();
			}
			
			// Handle 'all_seion' - return all basic/pure kana
			if (state.kanaSection === 'all_seion') {
				return [
					...kanaData.vowels,
					...kanaData.k_row,
					...kanaData.s_row,
					...kanaData.t_row,
					...kanaData.n_row,
					...kanaData.h_row,
					...kanaData.m_row,
					...kanaData.y_row,
					...kanaData.r_row,
					...kanaData.w_row
				];
			}
			
			// Handle 'all_dakuon' - return all voiced/semi-voiced kana
			if (state.kanaSection === 'all_dakuon') {
				return [
					...kanaData.g_row,
					...kanaData.z_row,
					...kanaData.d_row,
					...kanaData.b_row,
					...kanaData.p_row
				];
			}
			
			// Handle 'all_yoon' - return all combination kana
			if (state.kanaSection === 'all_yoon') {
				return [
					...kanaData.ky_yoon,
					...kanaData.sh_yoon,
					...kanaData.ch_yoon,
					...kanaData.ny_yoon,
					...kanaData.hy_yoon,
					...kanaData.my_yoon,
					...kanaData.ry_yoon,
					...kanaData.gy_yoon,
					...kanaData.j_yoon,
					...kanaData.by_yoon,
					...kanaData.py_yoon
				];
			}
			
			// Handle specific section
			if (kanaData[state.kanaSection]) {
				return kanaData[state.kanaSection];
			}
			
			// Fallback to vowels
			return kanaData.vowels;
		}

		function generateQuestion() {
			const kanaSet = getKanaSet();
			
			// Select a random kana that's different from the previous one
			let correctChar;
			if (kanaSet.length > 1) {
				// Filter out the previous character to ensure no repeat
				const availableKana = kanaSet.filter(k => k.char !== state.previousChar);
				correctChar = availableKana[Math.floor(Math.random() * availableKana.length)];
			} else {
				// Only one kana in set, must use it
				correctChar = kanaSet[0];
			}
			
			// Store current as previous for next round
			state.previousChar = correctChar.char;
			state.currentChar = correctChar.char;
			state.correctAnswer = correctChar.romaji;
			
			// Random font assignment for falling kana
			const kanaFonts = [
				"'Yomogi', cursive",
				"'Kosugi Maru', sans-serif",
				"'Kaisei Tokumin', serif",
				"'Kaisei Decol', serif",
				"'Zen Kurenaido', sans-serif",
				"'Sawarabi Mincho', serif",
				"'Sawarabi Gothic', sans-serif",
				"'Dela Gothic One', sans-serif",
				"'RocknRoll One', sans-serif",
				"'Hachi Maru Pop', cursive",
				"'Noto Sans JP', sans-serif",
				"'Yuji Mai', serif",
				"'Yuji Syuku', serif",
				"'Yuji Boku', serif",
				"'Reggae One', sans-serif",
				"'Train One', sans-serif",
				"'Hina Mincho', serif"
			];
			
			// Select a random font that's different from the previous one
			let newFont;
			if (kanaFonts.length > 1) {
				const availableFonts = kanaFonts.filter(f => f !== state.previousFont);
				newFont = availableFonts[Math.floor(Math.random() * availableFonts.length)];
			} else {
				newFont = kanaFonts[0];
			}
			
			// Store current font as previous for next round
			state.previousFont = newFont;
			state.randomFont = newFont;
			state.timeLeft = DIFFICULTY[state.difficulty].time;
			
			const wrongOptions = kanaSet
				.filter(k => k.romaji !== correctChar.romaji)
				.sort(() => Math.random() - 0.5)
				.slice(0, 3)
				.map(k => k.romaji);
			
			state.options = [correctChar.romaji, ...wrongOptions]
				.sort(() => Math.random() - 0.5);
		}

		let timerInterval = null;

		function startGame() {
			// Add gameplay-active class to prevent scrolling on mobile
			document.body.classList.add('gameplay-active');
			
			state.gameState = 'playing';
			state.score = 0;
			state.streak = 0;
			state.roundsPlayed = 0;
			state.correctCount = 0;
			state.incorrectCount = 0;
			state.startTime = Date.now();
			state.totalTime = 0;
			state.isNewRecord = false;
			
			// Reset previous tracking for fresh game
			state.previousChar = null;
			state.previousFont = null;
			
			if (state.sectionTimeLimit) {
				state.timeRemaining = state.sectionTimeLimit;
				state.timerInterval = setInterval(updateTimer, 1000);
			} else {
				state.timeRemaining = null;
				if (state.timerInterval) {
					clearInterval(state.timerInterval);
					state.timerInterval = null;
				}
			}
			
			generateQuestion();
			
			// Start the per-character timer
			if (timerInterval) clearInterval(timerInterval);
			timerInterval = setInterval(() => {
				// Stop timer if not in playing state
				if (state.gameState !== 'playing') {
					clearInterval(timerInterval);
					timerInterval = null;
					return;
				}
				state.timeLeft -= 0.01;
				if (state.sectionTimeLimit && state.timeRemaining !== null) {
					// Section timer is handled separately
				}
				if (state.timeLeft <= 0) {
					state.timeLeft = 0;
					handleTimeout();
				}
				updateGameTimer();
			}, 10);
			
			render();
		}

		function updateTimer() {
			if (state.timeRemaining !== null) {
				state.timeRemaining--;
				
				const timerEl = document.getElementById('timer');
				if (timerEl) {
					timerEl.textContent = state.timeRemaining;
				}
				
				if (state.timeRemaining <= 0) {
					endGame();
				}
			}
		}

		function updateGameTimer() {
			const timerBar = document.getElementById('timer-bar');
			const timerText = document.getElementById('timer-text');
			
			if (timerBar && timerText) {
				const maxTime = DIFFICULTY[state.difficulty].time;
				const percentage = (state.timeLeft / maxTime) * 100;
				timerBar.style.width = percentage + '%';
				timerText.textContent = state.timeLeft.toFixed(2) + 's';
			}
		}

		function handleTimeout() {
			// Don't process timeout if we're not in playing state
			if (state.gameState !== 'playing') {
				if (timerInterval) {
					clearInterval(timerInterval);
					timerInterval = null;
				}
				return;
			}
			
			if (timerInterval) {
				clearInterval(timerInterval);
				timerInterval = null;
			}
			
			state.incorrectCount++;
			state.streak = 0;
			
			const feedback = document.getElementById('feedback');
			if (feedback) {
				feedback.textContent = '‚è∞ Time Up!';
				feedback.className = 'feedback incorrect';
			}
			
			playSound('incorrect');
			
			setTimeout(() => {
				if (state.difficulty === 'hard') {
					endGame();
				} else {
					state.roundsPlayed++;
					generateQuestion();
					updatePlayingArea();
					
					// Restart timer only if still playing
					if (state.gameState === 'playing') {
						if (timerInterval) clearInterval(timerInterval);
						timerInterval = setInterval(() => {
							if (state.gameState !== 'playing') {
								clearInterval(timerInterval);
								timerInterval = null;
								return;
							}
							state.timeLeft -= 0.01;
							if (state.timeLeft <= 0) {
								state.timeLeft = 0;
								handleTimeout();
							}
							updateGameTimer();
						}, 10);
					}
				}
			}, 1500);
		}

		function updateTimer() {
			if (state.timeRemaining !== null) {
				state.timeRemaining--;
				
				const timerEl = document.getElementById('timer');
				if (timerEl) {
					timerEl.textContent = state.timeRemaining;
				}
				
				if (state.timeRemaining <= 0) {
					endGame();
				}
			}
		}

		function checkAnswer(selectedAnswer) {
			if (timerInterval) {
				clearInterval(timerInterval);
				timerInterval = null;
			}
			
			const roundTime = (Date.now() - state.roundStartTime) / 1000;
			state.totalTime += roundTime;
			
			const isCorrect = selectedAnswer === state.correctAnswer;
			
			const buttons = document.querySelectorAll('.answer-button');
			buttons.forEach(btn => {
				btn.disabled = true;
				if (btn.dataset.answer === state.correctAnswer) {
					btn.classList.add('correct');
				} else if (btn.dataset.answer === selectedAnswer && !isCorrect) {
					btn.classList.add('incorrect');
				}
			});
			
			const kanaDisplay = document.querySelector('.kana-display');
			const feedback = document.getElementById('feedback');
			
			if (isCorrect) {
				state.score += Math.max(10, Math.floor(20 - roundTime));
				state.correctCount++;
				state.streak++;
				if (state.streak > state.bestStreak) {
					state.bestStreak = state.streak;
				}
				
				kanaDisplay.classList.add('correct');
				if (feedback) {
					feedback.textContent = '‚úì Correct!';
					feedback.className = 'feedback correct';
				}
				playSound('correct');
				
				checkAchievements();
				
				setTimeout(() => {
					state.roundsPlayed++;
					
					if (state.difficulty === 'hard' && state.roundsPlayed >= 20) {
						endGame();
					} else if (state.difficulty === 'medium' && state.roundsPlayed >= 30) {
						endGame();
					} else if (state.difficulty === 'easy' && state.roundsPlayed >= 40) {
						endGame();
					} else {
						generateQuestion();
						updatePlayingArea();
						
						// Restart timer only if still playing
						if (state.gameState === 'playing') {
							if (timerInterval) clearInterval(timerInterval);
							timerInterval = setInterval(() => {
								if (state.gameState !== 'playing') {
									clearInterval(timerInterval);
									timerInterval = null;
									return;
								}
								state.timeLeft -= 0.01;
								if (state.timeLeft <= 0) {
									state.timeLeft = 0;
									handleTimeout();
								}
								updateGameTimer();
							}, 10);
						}
					}
				}, 1000);
			} else {
				state.incorrectCount++;
				state.streak = 0;
				
				kanaDisplay.classList.add('incorrect');
				if (feedback) {
					feedback.textContent = '‚úó Wrong! (' + state.correctAnswer + ')';
					feedback.className = 'feedback incorrect';
				}
				playSound('incorrect');
				
				setTimeout(() => {
					if (state.difficulty === 'hard') {
						endGame();
					} else {
						state.roundsPlayed++;
						generateQuestion();
						updatePlayingArea();
						
						// Restart timer only if still playing
						if (state.gameState === 'playing') {
							if (timerInterval) clearInterval(timerInterval);
							timerInterval = setInterval(() => {
								if (state.gameState !== 'playing') {
									clearInterval(timerInterval);
									timerInterval = null;
									return;
								}
								state.timeLeft -= 0.01;
								if (state.timeLeft <= 0) {
									state.timeLeft = 0;
									handleTimeout();
								}
								updateGameTimer();
							}, 10);
						}
					}
				}, 1000);
			}
		}

		function endGame() {
			// Remove gameplay-active class to restore scrolling
			document.body.classList.remove('gameplay-active');
			
			if (timerInterval) {
				clearInterval(timerInterval);
				timerInterval = null;
			}
			if (state.timerInterval) {
				clearInterval(state.timerInterval);
				state.timerInterval = null;
			}
			
			state.totalRoundsPlayed++;
			if (state.kanaType === 'hiragana') {
				state.hiraganaRoundsPlayed++;
				state.hasPlayedHiragana = true;
			} else {
				state.katakanaRoundsPlayed++;
				state.hasPlayedKatakana = true;
			}
			
			if (state.difficulty === 'hard') {
				state.hardModeRounds++;
			}
			
			checkAchievements();
			saveAchievementData();
			
			saveScore();
			state.gameState = 'gameover';
			render();
		}

		// ===== ACHIEVEMENTS =====
		function checkAchievements() {
			const unlocked = [];
			
			if (state.roundsPlayed >= 1 && !state.unlockedAchievements.includes('first_steps')) {
				unlocked.push('first_steps');
			}
			if (state.totalRoundsPlayed >= 10 && !state.unlockedAchievements.includes('dedication')) {
				unlocked.push('dedication');
			}
			if (state.totalRoundsPlayed >= 50 && !state.unlockedAchievements.includes('veteran')) {
				unlocked.push('veteran');
			}
			if (state.totalRoundsPlayed >= 100 && !state.unlockedAchievements.includes('master')) {
				unlocked.push('master');
			}
			
			if (state.streak >= 5 && !state.unlockedAchievements.includes('streak_5')) {
				unlocked.push('streak_5');
			}
			if (state.streak >= 10 && !state.unlockedAchievements.includes('streak_10')) {
				unlocked.push('streak_10');
			}
			if (state.streak >= 20 && !state.unlockedAchievements.includes('streak_20')) {
				unlocked.push('streak_20');
			}
			
			if (state.hiraganaRoundsPlayed >= 10 && !state.unlockedAchievements.includes('hiragana_hero')) {
				unlocked.push('hiragana_hero');
			}
			if (state.katakanaRoundsPlayed >= 10 && !state.unlockedAchievements.includes('katakana_king')) {
				unlocked.push('katakana_king');
			}
			if (state.hasPlayedHiragana && state.hasPlayedKatakana && !state.unlockedAchievements.includes('both_scripts')) {
				unlocked.push('both_scripts');
			}
			
			if (state.hardModeRounds >= 5 && !state.unlockedAchievements.includes('hard_mode')) {
				unlocked.push('hard_mode');
			}
			
			const avgTime = state.roundsPlayed > 0 ? state.totalTime / state.roundsPlayed : 0;
			if (avgTime < 2 && state.roundsPlayed >= 10 && !state.unlockedAchievements.includes('speed_demon')) {
				unlocked.push('speed_demon');
			}
			
			unlocked.forEach(id => {
				if (!state.unlockedAchievements.includes(id)) {
					state.unlockedAchievements.push(id);
					showAchievementNotification(ACHIEVEMENTS[id]);
				}
			});
		}

		function showAchievementNotification(achievement) {
			playSound('achievement');
			
			const notification = document.createElement('div');
			notification.style.cssText = `
				position: fixed;
				top: 16px;
				right: 16px;
				background: linear-gradient(135deg, #4caf50, #66bb6a);
				color: white;
				padding: 1rem 1.5rem;
				border-radius: 0.75rem;
				box-shadow: 0 4px 20px rgba(0,0,0,0.3);
				z-index: 10000;
				animation: slideIn 0.5s ease-out;
				font-family: var(--font-family);
			`;
			notification.innerHTML = `
				<div style="font-size: 2rem; text-align: center;">${achievement.icon}</div>
				<div style="font-weight: bold; margin-top: 0.5rem;">${achievement.name}</div>
				<div style="font-size: 0.9rem; opacity: 0.9;">${achievement.desc}</div>
			`;
			
			document.body.appendChild(notification);
			
			setTimeout(() => {
				notification.style.animation = 'slideOut 0.5s ease-in';
				setTimeout(() => notification.remove(), 500);
			}, 3000);
		}

		function saveAchievementData() {
			const data = {
				unlockedAchievements: state.unlockedAchievements,
				totalRoundsPlayed: state.totalRoundsPlayed,
				hiraganaRoundsPlayed: state.hiraganaRoundsPlayed,
				katakanaRoundsPlayed: state.katakanaRoundsPlayed,
				hardModeRounds: state.hardModeRounds,
				hasPlayedHiragana: state.hasPlayedHiragana,
				hasPlayedKatakana: state.hasPlayedKatakana
			};
			localStorage.setItem('kanaBlitzAchievements', JSON.stringify(data));
		}

		function loadAchievementData() {
			const saved = localStorage.getItem('kanaBlitzAchievements');
			if (saved) {
				const data = JSON.parse(saved);
				state.unlockedAchievements = data.unlockedAchievements || [];
				state.totalRoundsPlayed = data.totalRoundsPlayed || 0;
				state.hiraganaRoundsPlayed = data.hiraganaRoundsPlayed || 0;
				state.katakanaRoundsPlayed = data.katakanaRoundsPlayed || 0;
				state.hardModeRounds = data.hardModeRounds || 0;
				state.hasPlayedHiragana = data.hasPlayedHiragana || false;
				state.hasPlayedKatakana = data.hasPlayedKatakana || false;
			}
		}

		// ===== LEADERBOARD =====
		function saveScore() {
			const avgTime = state.roundsPlayed > 0 ? (state.totalTime / state.roundsPlayed).toFixed(2) : '0.00';
			
			// Determine kana type display name
			let kanaTypeDisplay;
			if (state.kanaType === 'comprehensive') {
				kanaTypeDisplay = 'Comprehensive (All)';
			} else if (state.kanaType === 'hiragana') {
				kanaTypeDisplay = 'Hiragana';
			} else {
				kanaTypeDisplay = 'Katakana';
			}
			
			const entry = {
				score: state.score,
				rounds: state.roundsPlayed,
				streak: state.bestStreak,
				avgTime: avgTime,
				kanaType: kanaTypeDisplay,
				difficulty: state.difficulty.charAt(0).toUpperCase() + state.difficulty.slice(1),
				date: new Date().toLocaleDateString()
			};
			
			let leaderboard = JSON.parse(localStorage.getItem('kanaBlitzLeaderboard') || '[]');
			
			const isNewRecord = leaderboard.length === 0 || entry.score > leaderboard[0].score;
			state.isNewRecord = isNewRecord;
			
			leaderboard.push(entry);
			leaderboard.sort((a, b) => b.score - a.score);
			leaderboard = leaderboard.slice(0, 10);
			
			localStorage.setItem('kanaBlitzLeaderboard', JSON.stringify(leaderboard));
		}

		function getLeaderboard() {
			return JSON.parse(localStorage.getItem('kanaBlitzLeaderboard') || '[]');
		}

		// ===== CONFETTI =====
		function launchConfetti() {
			const canvas = document.getElementById('confetti-canvas');
			const ctx = canvas.getContext('2d');
			canvas.width = window.innerWidth;
			canvas.height = window.innerHeight;
			
			const confetti = [];
			const confettiCount = 150;
			const colors = ['#ff6b6b', '#4ecdc4', '#45b7d1', '#f9ca24', '#f0932b', '#eb4d4b', '#6c5ce7'];
			
			for (let i = 0; i < confettiCount; i++) {
				confetti.push({
					x: Math.random() * canvas.width,
					y: Math.random() * canvas.height - canvas.height,
					size: Math.random() * 8 + 4,
					speedY: Math.random() * 3 + 2,
					speedX: Math.random() * 2 - 1,
					color: colors[Math.floor(Math.random() * colors.length)],
					rotation: Math.random() * 360,
					rotationSpeed: Math.random() * 10 - 5
				});
			}
			
			function drawConfetti() {
				ctx.clearRect(0, 0, canvas.width, canvas.height);
				
				confetti.forEach((p, index) => {
					ctx.save();
					ctx.translate(p.x, p.y);
					ctx.rotate((p.rotation * Math.PI) / 180);
					ctx.fillStyle = p.color;
					ctx.fillRect(-p.size / 2, -p.size / 2, p.size, p.size);
					ctx.restore();
					
					p.y += p.speedY;
					p.x += p.speedX;
					p.rotation += p.rotationSpeed;
					
					if (p.y > canvas.height) {
						confetti.splice(index, 1);
					}
				});
				
				if (confetti.length > 0) {
					requestAnimationFrame(drawConfetti);
				} else {
					ctx.clearRect(0, 0, canvas.width, canvas.height);
				}
			}
			
			drawConfetti();
		}

		// ===== NUMBER ANIMATION =====
		function animateNumber(element, target, duration) {
			const start = 0;
			const increment = target / (duration / 16);
			let current = start;
			
			const timer = setInterval(() => {
				current += increment;
				if (current >= target) {
					current = target;
					clearInterval(timer);
				}
				element.textContent = Math.floor(current);
			}, 16);
		}

		// ===== RENDER FUNCTIONS =====
		function renderMenu() {
			return `
				<div class="game-container">
					<div class="card">
						<div class="h1">
							<h1>„Å≤„Çâ„Éñ„É™ÔºÅ<br>„ÄåHira Buri!„Äç</h1>
						</div>
						
						<div class="btn-group" style="flex-direction: column;">
							<button class="btn btn-primary" onclick="showGameMode()">
								„ÅØ„Åò„ÇÅ„Çã<br>„ÄåPlay„Äç
							</button>
							<button class="btn btn-secondary" onclick="showStats()">
								„Éñ„É™„É≠„Ç∞<br>„ÄåBrilliance Log„Äç
							</button>
							<button class="btn btn-gray" onclick="showSettings()">
								„Åõ„Å£„Å¶„ÅÑ<br>„ÄåSettings„Äç
							</button>
						</div>
					</div>
				</div>
			`;
		}

		function renderSettings() {
			let currentTheme = 'dawn';
			if (document.body.classList.contains('midnight-theme')) currentTheme = 'midnight';
			const currentAudio = state.audioEnabled ? 'on' : 'off';
			
			return `
				<div class="game-container">
					<div class="card large-card">
						<h2>„Åõ„Å£„Å¶„ÅÑ<br>„ÄåSettings„Äç</h2>
						
						<div class="settings-group">
							<div class="setting-item">
								<label class="setting-label">
									üé® „ÉÜ„Éº„Éû„ÄåTheme„Äç
								</label>
								<select id="themeSelect" class="setting-select" onchange="changeTheme(this.value)">
									<option value="dawn" ${currentTheme === 'dawn' ? 'selected' : ''}>üåá Dawn Minimalist</option>
									<option value="midnight" ${currentTheme === 'midnight' ? 'selected' : ''}>üåÉ Midnight Sky</option>
								</select>
							</div>
							
							<div class="setting-item">
								<label class="setting-label">
									üîä „Åä„Å®„ÄåSound„Äç
								</label>
								<select id="audioSelect" class="setting-select" onchange="changeAudio(this.value)">
									<option value="on" ${currentAudio === 'on' ? 'selected' : ''}>üîä On</option>
									<option value="off" ${currentAudio === 'off' ? 'selected' : ''}>üîá Off</option>
								</select>
							</div>
						</div>
						
						<div class="btn-group mt-4">
							<button class="btn btn-gray" onclick="backToMenu()">„ÇÇ„Å©„Çã„ÄåReturn„Äç</button>
						</div>
					</div>
				</div>
			`;
		}

		function renderGameMode() {
			return `
				<div class="game-container">
                    <div class="card large-card">
						<div class="h1">
							<h1>„Éñ„É™„ÉÅ„É£„É¨„É≥„Ç∏„Åà„Çâ„Å∂ÔºÅ<br>‚Üí Choose Buri!</h1>
						</div>
                        
						<div class="section-selector">
							<label class="time-limit-label">„Ç´„Éä„Åà„Çâ„Å∂<br>„ÄåSelect Kana„Äç:</label>
							<select id="kanaType" class="section-option" style="width: 100%; margin-bottom: 1rem;" onchange="updateSectionOptions()">
								<option value="hiragana">„Å≤„Çâ„Åå„Å™ Hiragana</option>
								<option value="katakana">„Ç´„Çø„Ç´„Éä Katakana</option>
							</select>
							
							<label class="time-limit-label">„Ç´„ÉÜ„Ç¥„É™„Åà„Çâ„Å∂<br>„ÄåSelect Category„Äç:</label>
							<div class="category-tabs">
								<button class="category-tab active" data-category="seion" onclick="selectCategory('seion')">
									Ê∏ÖÈü≥<br><small>Seion</small>
								</button>
								<button class="category-tab" data-category="dakuon" onclick="selectCategory('dakuon')">
									ÊøÅÈü≥<br><small>Dakuon</small>
								</button>
								<button class="category-tab" data-category="yoon" onclick="selectCategory('yoon')">
									ÊãóÈü≥<br><small>Y≈çon</small>
								</button>
							</div>
							
							<label class="time-limit-label" style="margin-top: 1rem;">„Çª„ÇØ„Ç∑„Éß„É≥„Åà„Çâ„Å∂<br>„ÄåSelect Section„Äç:</label>
							<select id="kanaSection" class="section-option" style="width: 100%; margin-bottom: 0.5rem;">
								<option value="vowels">Vowels („ÅÇ, „ÅÑ, „ÅÜ, „Åà, „Åä)</option>
								<option value="k_row">K-row („Åã, „Åç, „Åè, „Åë, „Åì)</option>
								<option value="s_row">S-row („Åï, „Åó, „Åô, „Åõ, „Åù)</option>
								<option value="t_row">T-row („Åü, „Å°, „Å§, „Å¶, „Å®)</option>
								<option value="n_row">N-row („Å™, „Å´, „Å¨, „Å≠, „ÅÆ)</option>
								<option value="h_row">H-row („ÅØ, „Å≤, „Åµ, „Å∏, „Åª)</option>
								<option value="m_row">M-row („Åæ, „Åø, „ÇÄ, „ÇÅ, „ÇÇ)</option>
								<option value="y_row">Y-row („ÇÑ, „ÇÜ, „Çà)</option>
								<option value="r_row">R-row („Çâ, „Çä, „Çã, „Çå, „Çç)</option>
								<option value="w_row">W-row („Çè, „Çí, „Çì)</option>
								<option value="all_seion">ÂÖ®Ê∏ÖÈü≥„ÄåAll Seion„Äç</option>
							</select>
							
							<div class="time-limit-group">
								<label class="time-limit-label">„Éñ„É™„Çø„Ç§„É†<br>„ÄåTime Limit„Äç:</label>
								<select id="timeLimit" class="time-limit-select">
									<option value="unlimited">Unlimited</option>
									<option value="30">30 seconds</option>
									<option value="60" selected>60 seconds</option>
									<option value="120">2 minutes</option>
									<option value="300">5 minutes</option>
								</select>
							</div>
							
							<button class="btn btn-primary section-start-btn" onclick="startKanaBlitz()">
								„ÅØ„Åò„Éñ„É™ÔºÅ(„ÜÜ ·¥ó „ÜÜ)<br>„ÄåStart Blitz!„Äç
							</button>
						</div>
						
						<div style="text-align: center; margin: 1.5rem 0; color: var(--secondary-color); font-size: 0.9rem;">
							<br>‚ï≠( ‡πê _‡πê)‚ïÆ‚Äîor </br>„Éñ„É™„Ç≥„É≥„Éó„É™„Éº„Éà„ÉÅ„É£„É¨„É≥„Ç∏ÔºÅ<br>„ÄåBuri Complete Challenge!„Äç<br>‚Äî(; Íí™√∂Íí™)
						</div>
						
						<div class="section-selector">
							<label class="time-limit-label">ÂÖ®ÈÉ®„Ç´„Éä„Åà„Çâ„Å∂<br>„ÄåAll Kana Select„Äç:</label>
							<select id="zenbuBuri" class="section-option" style="width: 100%; margin-bottom: 0.5rem;">
								<option value="">‚Äî Select All ‚Äî</option>
								<option value="all_hiragana">ÂÖ®„Å≤„Çâ„Åå„Å™ (All Hiragana)</option>
								<option value="all_katakana">ÂÖ®„Ç´„Çø„Ç´„Éä (All Katakana)</option>
								<option value="comprehensive">ÂÖ®ÈÉ® (All Hiragana √ó Katakana)</option>
							</select>
							
							<button class="btn btn-primary section-start-btn" onclick="startZenbuBuri()">
								(„ÜÜ ·¥ó „ÜÜ)„ÅØ„ÅòÂÖ®ÈÉ®„Éñ„É™ÔºÅ<br>„ÄåStart Zenbu Buri!„Äç
							</button>
						</div>
						
						<div class="btn-group mt-4">
							<button class="btn btn-gray" onclick="backToMenu()">Return ‚Äì „ÇÇ„Å©„Çã</button>
						</div>
					</div>
				</div>
			`;
		}

		function renderPlaying() {
			state.roundStartTime = Date.now();			
			const maxRounds = state.difficulty === 'hard' ? 20 : state.difficulty === 'medium' ? 30 : 40;
			const progress = (state.roundsPlayed / maxRounds) * 100;			
			const animationDuration = DIFFICULTY[state.difficulty].time;
			const kanaChar = state.currentChar;
			
			return `
				<div class="floating-controls">
					<button class="floating-btn" onclick="endGame()">‚úñ Exit</button>
				</div>

				<div class="game-container">
					<div class="card large-card">
						<div class="stats-bar">
							<div class="stat">
								<div class="stat-label">SCORE</div>
								<div class="stat-value" id="score-value">${state.score}</div>
							</div>
							<div class="stat">
								<div class="stat-label">STREAK</div>
								<div class="stat-value" id="streak-value">${state.streak}</div>
							</div>
							<div class="stat">
								<div class="stat-label">ROUND</div>
								<div class="stat-value" id="round-value">${state.roundsPlayed}/${maxRounds}</div>
							</div>
							${state.timeRemaining !== null ? `
								<div class="stat">
									<div class="stat-label">TIME</div>
									<div class="stat-value" id="timer">${state.timeRemaining}</div>
								</div>
							` : ''}
						</div>
						
						<div class="progress-container">
							<div class="progress-bar">
								<div class="progress-fill" id="progress-fill" style="width: ${progress}%"></div>
							</div>
						</div>
						
						<div class="progress-container">
							<div class="progress-bar" id="timer-bar-container">
								<div id="timer-bar" class="progress-fill green" style="width: 100%"></div>
							</div>
						</div>
						<div id="timer-text" class="text-center" style="margin-bottom: 1rem; font-weight: bold;">${state.timeLeft.toFixed(2)}s</div>
						
						<div class="playing-area">
							<div class="kana-display" id="kana-display">
								<div class="kana-character kana-text falling random-font" id="kana-character"
									 style="font-family: ${state.randomFont}; animation-duration: ${animationDuration}s; animation-play-state: ${state.timeLeft > 0 ? 'running' : 'paused'}">
									${kanaChar}
								</div>
								<div class="ground-line"></div>
								<div id="feedback" class="feedback"></div>
							</div>
							
							<div class="answer-grid" id="answer-grid">
								${state.options.map(option => `
									<button class="answer-button" 
											data-answer="${option}"
											onclick="checkAnswer('${option}')">
										${option}
									</button>
								`).join('')}
							</div>
						</div>
					</div>
				</div>
			`;
		}

		// Update only the dynamic elements without full re-render (prevents flicker)
		function updatePlayingArea() {
			state.roundStartTime = Date.now();
			const maxRounds = state.difficulty === 'hard' ? 20 : state.difficulty === 'medium' ? 30 : 40;
			const progress = (state.roundsPlayed / maxRounds) * 100;
			const animationDuration = DIFFICULTY[state.difficulty].time;
			
			// Update stats
			const scoreEl = document.getElementById('score-value');
			const streakEl = document.getElementById('streak-value');
			const roundEl = document.getElementById('round-value');
			const progressEl = document.getElementById('progress-fill');
			
			if (scoreEl) scoreEl.textContent = state.score;
			if (streakEl) streakEl.textContent = state.streak;
			if (roundEl) roundEl.textContent = `${state.roundsPlayed}/${maxRounds}`;
			if (progressEl) progressEl.style.width = `${progress}%`;
			
			// Update kana display
			const kanaDisplay = document.getElementById('kana-display');
			const kanaCharacter = document.getElementById('kana-character');
			
			if (kanaDisplay) {
				kanaDisplay.classList.remove('correct', 'incorrect');
			}
			
			if (kanaCharacter) {
				// Reset animation by cloning and replacing
				const newKana = kanaCharacter.cloneNode(false);
				newKana.id = 'kana-character';
				newKana.className = 'kana-character kana-text falling random-font';
				newKana.style.fontFamily = state.randomFont;
				newKana.style.animationDuration = `${animationDuration}s`;
				newKana.style.animationPlayState = 'running';
				newKana.textContent = state.currentChar;
				kanaCharacter.parentNode.replaceChild(newKana, kanaCharacter);
			}
			
			// Update feedback
			const feedback = document.getElementById('feedback');
			if (feedback) {
				feedback.textContent = '';
				feedback.className = 'feedback';
			}
			
			// Update answer buttons
			const answerGrid = document.getElementById('answer-grid');
			if (answerGrid) {
				answerGrid.innerHTML = state.options.map(option => `
					<button class="answer-button" 
							data-answer="${option}"
							onclick="checkAnswer('${option}')">
						${option}
					</button>
				`).join('');
			}
			
			// Reset timer bar
			const timerBar = document.getElementById('timer-bar');
			const timerText = document.getElementById('timer-text');
			if (timerBar) timerBar.style.width = '100%';
			if (timerText) timerText.textContent = `${state.timeLeft.toFixed(2)}s`;
		}

		function renderGameOver() {
			const avgTime = state.roundsPlayed > 0 ? (state.totalTime / state.roundsPlayed).toFixed(2) : '0.00';
			
			const template = `
				<div class="game-container">
					<div class="card large-card game-over-container">
						<h2 class="gradient-text">„Éñ„É™ÁµÇ‰∫ÜÔºÅ<br><small>„ÄåGame Over„Äç<br>‡ºé‡∫∂‚Äø‡ºé‡∫∂</small></h2>
						
						${state.isNewRecord ? `
							<div class="new-record-badge">
								üèÜ NEW RECORD! üèÜ
							</div>
						` : ''}
						
						<div class="final-score" id="finalScore">${state.score}</div>
						
						<div class="score-details">
							<div class="score-item">
								<div class="score-item-label">Correct</div>
								<div class="score-item-value" id="correctCount">${state.correctCount}</div>
							</div>
							<div class="score-item">
								<div class="score-item-label">Best Streak</div>
								<div class="score-item-value" id="bestStreak">${state.bestStreak}</div>
							</div>
							<div class="score-item">
								<div class="score-item-label">Total Rounds</div>
								<div class="score-item-value" id="totalRounds">${state.roundsPlayed}</div>
							</div>
							<div class="score-item">
								<div class="score-item-label">Avg Time</div>
								<div class="score-item-value" id="avgTime">${avgTime}s</div>
							</div>
						</div>
						
						<div class="btn-group" style="flex-direction: column;">
							<button class="btn btn-primary" onclick="showGameMode()">„ÇÇ„ÅÜ‰∏Ä„Éñ„É™ÔºÅ<br><small>„ÄåPlay Again„Äç</small></button>
							<button class="btn btn-secondary" onclick="showStats()">„Éñ„É™„É≠„Ç∞<br><small>„ÄåBuriLog„Äç</small></button>
							<button class="btn btn-gray" onclick="backToMenu()">„É°„Ç§„É≥ÁîªÈù¢<br><small>„ÄåMain Menu„Äç</small></button>
						</div>
					</div>
				</div>
			`;
			
			setTimeout(() => {
			  const s = document.getElementById('finalScore');
			  const c = document.getElementById('correctCount');
			  const st = document.getElementById('bestStreak');
			  const r = document.getElementById('totalRounds');
			  const a = document.getElementById('avgTime');
			  if(s) animateNumber(s, state.score, 1000);
			  if(st) animateNumber(st, state.bestStreak, 900);
			  if(r) animateNumber(r, state.roundsPlayed, 900);
			  if(a) animateNumber(a, Number((state.roundsPlayed>0?(state.totalTime/state.roundsPlayed):0).toFixed(2))*100, 900);
			  setTimeout(()=>{ if(a) a.textContent = (state.roundsPlayed>0?(state.totalTime/state.roundsPlayed):0).toFixed(2); }, 950);
			  if(state.isNewRecord) launchConfetti();
			}, 0);
			return template;
		}

		function renderStats() {
			const leaderboard = getLeaderboard();
			
		return `
				<div class="game-container">
					<div class="card large-card">
						<h2 class="gradient-text">
							„Éñ„É™„É≠„Ç∞<br>
							„ÄåBrilliance Log„Äç
						</h2>
						
						<div class="tabs">
							<button class="tab ${state.statsTab === 'leaderboard' ? 'active' : ''}" 
									onclick="switchStatsTab('leaderboard')">
								„Éñ„É™„Éú„Éº„Éâ<br>
								„ÄåBurib≈çdo„Äç<br>
								<small>Leaderboard</small>
							</button>
							<button class="tab ${state.statsTab === 'achievements' ? 'active' : ''}" 
									onclick="switchStatsTab('achievements')">
								ÈÅîÊàê„Éñ„É™ÔºÅ<br>
								„ÄåTassei Buri!„Äç<br>
								<small>Achievements</small>
								(${state.unlockedAchievements.length}/${Object.keys(ACHIEVEMENTS).length})
							</button>
						</div>
						
						${state.statsTab === 'leaderboard' ? `
							<div class="overflow-auto">
								${leaderboard.length === 0 ? `
									<p class="text-center text-gray" style="padding: 3rem 0;">
										No scores yet. Play a game!
									</p>
								` : leaderboard.map((entry, index) => `
									<div class="leaderboard-entry">
										<div class="leaderboard-rank ${index === 0 ? 'gold' : index === 1 ? 'silver' : index === 2 ? 'bronze' : ''}">
											#${index + 1}
										</div>
										<div class="leaderboard-info">
											<div class="leaderboard-score">${entry.score} pts</div>
											<div class="leaderboard-details">
												${entry.rounds} rounds ‚Ä¢ Streak: ${entry.streak} ‚Ä¢ Avg: ${entry.avgTime}s
											</div>
											<div class="text-xs text-gray">
												${entry.kanaType} ‚Ä¢ ${entry.difficulty} ‚Ä¢ ${entry.date}
											</div>
										</div>
									</div>
								`).join('')} </div>
						` : `
							<p class="text-center text-gray mb-3">
								${state.unlockedAchievements.length} of ${Object.keys(ACHIEVEMENTS).length} unlocked
							</p>
							
							<div class="progress-bar mb-3">
								<div class="progress-fill green" 
									 style="width: ${(state.unlockedAchievements.length / Object.keys(ACHIEVEMENTS).length) * 100}%">
								</div>
							</div>
							
							<div class="overflow-auto">
								<div class="achievement-grid">
									${Object.values(ACHIEVEMENTS).map(achievement => {
										const isUnlocked = state.unlockedAchievements.includes(achievement.id);
										return `
											<div class="achievement-card ${isUnlocked ? 'unlocked' : 'locked'}">
												<div class="achievement-icon">${achievement.icon}</div>
												<div class="achievement-info">
													<div class="achievement-name">${achievement.name}</div>
													<div class="achievement-desc">${achievement.desc}</div>
													${isUnlocked ? '<div class="achievement-status">‚úì Unlocked</div>' : ''}
												</div>
											</div>
										`;
									}).join('')} </div>
							</div>
						`}
						
						<div class="btn-group mt-4">
							<button class="btn btn-gray" onclick="backToMenu()">Return ‚Äì „ÇÇ„Å©„Çã</button>
							${state.statsTab === 'leaderboard' ? '<button class="btn btn-secondary" onclick="clearLeaderboard()">Clear Data</button>' : ''}
						</div>
					</div>
				</div>
			`;
		}





		function render() {
			const app = document.getElementById('app');
			
			let html = '';
			switch (state.gameState) {
				case 'menu':
					html = renderMenu();
					break;
				case 'gameMode':                    html = renderGameMode();                    break;
				case 'playing':
					html = renderPlaying();
					break;
				case 'gameover':
					html = renderGameOver();
					break;
				case 'stats':
					html = renderStats();
					break;
				case 'settings':
					html = renderSettings();
					break;
			}
			
			app.innerHTML = html;
		}

		// ===== EVENT HANDLERS (attached to window for onclick) =====
		window.setKanaAndDifficulty = (kanaType, difficulty) => {
			state.kanaType = kanaType;
			state.difficulty = difficulty;
			state.kanaSection = 'vowels';  // Reset to default
			startGame();
		};

		window.setKanaAndDifficultyWithSection = (kanaType, difficulty, section) => {
			state.kanaType = kanaType;
			state.difficulty = difficulty;
			state.kanaSection = section;
			startGame();
		};

		// Section options data organized by category for each kana type
		const SECTION_OPTIONS = {
			hiragana: {
				seion: [
					{ value: 'vowels', label: 'Vowels („ÅÇ, „ÅÑ, „ÅÜ, „Åà, „Åä)' },
					{ value: 'k_row', label: 'K-row („Åã, „Åç, „Åè, „Åë, „Åì)' },
					{ value: 's_row', label: 'S-row („Åï, „Åó, „Åô, „Åõ, „Åù)' },
					{ value: 't_row', label: 'T-row („Åü, „Å°, „Å§, „Å¶, „Å®)' },
					{ value: 'n_row', label: 'N-row („Å™, „Å´, „Å¨, „Å≠, „ÅÆ)' },
					{ value: 'h_row', label: 'H-row („ÅØ, „Å≤, „Åµ, „Å∏, „Åª)' },
					{ value: 'm_row', label: 'M-row („Åæ, „Åø, „ÇÄ, „ÇÅ, „ÇÇ)' },
					{ value: 'y_row', label: 'Y-row („ÇÑ, „ÇÜ, „Çà)' },
					{ value: 'r_row', label: 'R-row („Çâ, „Çä, „Çã, „Çå, „Çç)' },
					{ value: 'w_row', label: 'W-row („Çè, „Çí, „Çì)' },
					{ value: 'all_seion', label: 'ÂÖ®Ê∏ÖÈü≥„ÄåAll Seion„Äç' }
				],
				dakuon: [
					{ value: 'g_row', label: 'G-row („Åå, „Åé, „Åê, „Åí, „Åî)' },
					{ value: 'z_row', label: 'Z-row („Åñ, „Åò, „Åö, „Åú, „Åû)' },
					{ value: 'd_row', label: 'D-row („Å†, „Å¢, „Å•, „Åß, „Å©)' },
					{ value: 'b_row', label: 'B-row („Å∞, „Å≥, „Å∂, „Åπ, „Åº)' },
					{ value: 'p_row', label: 'P-row („Å±, „Å¥, „Å∑, „Å∫, „ÅΩ)' },
					{ value: 'all_dakuon', label: 'ÂÖ®ÊøÅÈü≥„ÄåAll Dakuon„Äç' }
				],
				yoon: [
					{ value: 'ky_yoon', label: 'KY („Åç„ÇÉ, „Åç„ÇÖ, „Åç„Çá)' },
					{ value: 'sh_yoon', label: 'SH („Åó„ÇÉ, „Åó„ÇÖ, „Åó„Çá)' },
					{ value: 'ch_yoon', label: 'CH („Å°„ÇÉ, „Å°„ÇÖ, „Å°„Çá)' },
					{ value: 'ny_yoon', label: 'NY („Å´„ÇÉ, „Å´„ÇÖ, „Å´„Çá)' },
					{ value: 'hy_yoon', label: 'HY („Å≤„ÇÉ, „Å≤„ÇÖ, „Å≤„Çá)' },
					{ value: 'my_yoon', label: 'MY („Åø„ÇÉ, „Åø„ÇÖ, „Åø„Çá)' },
					{ value: 'ry_yoon', label: 'RY („Çä„ÇÉ, „Çä„ÇÖ, „Çä„Çá)' },
					{ value: 'gy_yoon', label: 'GY („Åé„ÇÉ, „Åé„ÇÖ, „Åé„Çá)' },
					{ value: 'j_yoon', label: 'J („Åò„ÇÉ, „Åò„ÇÖ, „Åò„Çá)' },
					{ value: 'by_yoon', label: 'BY („Å≥„ÇÉ, „Å≥„ÇÖ, „Å≥„Çá)' },
					{ value: 'py_yoon', label: 'PY („Å¥„ÇÉ, „Å¥„ÇÖ, „Å¥„Çá)' },
					{ value: 'all_yoon', label: 'ÂÖ®ÊãóÈü≥„ÄåAll Y≈çon„Äç' }
				]
			},
			katakana: {
				seion: [
					{ value: 'vowels', label: 'Vowels („Ç¢, „Ç§, „Ç¶, „Ç®, „Ç™)' },
					{ value: 'k_row', label: 'K-row („Ç´, „Ç≠, „ÇØ, „Ç±, „Ç≥)' },
					{ value: 's_row', label: 'S-row („Çµ, „Ç∑, „Çπ, „Çª, „ÇΩ)' },
					{ value: 't_row', label: 'T-row („Çø, „ÉÅ, „ÉÑ, „ÉÜ, „Éà)' },
					{ value: 'n_row', label: 'N-row („Éä, „Éã, „Éå, „Éç, „Éé)' },
					{ value: 'h_row', label: 'H-row („Éè, „Éí, „Éï, „Éò, „Éõ)' },
					{ value: 'm_row', label: 'M-row („Éû, „Éü, „É†, „É°, „É¢)' },
					{ value: 'y_row', label: 'Y-row („É§, „É¶, „É®)' },
					{ value: 'r_row', label: 'R-row („É©, „É™, „É´, „É¨, „É≠)' },
					{ value: 'w_row', label: 'W-row („ÉØ, „É≤, „É≥)' },
					{ value: 'all_seion', label: 'ÂÖ®Ê∏ÖÈü≥„ÄåAll Seion„Äç' }
				],
				dakuon: [
					{ value: 'g_row', label: 'G-row („Ç¨, „ÇÆ, „Ç∞, „Ç≤, „Ç¥)' },
					{ value: 'z_row', label: 'Z-row („Ç∂, „Ç∏, „Ç∫, „Çº, „Çæ)' },
					{ value: 'd_row', label: 'D-row („ÉÄ, „ÉÇ, „ÉÖ, „Éá, „Éâ)' },
					{ value: 'b_row', label: 'B-row („Éê, „Éì, „Éñ, „Éô, „Éú)' },
					{ value: 'p_row', label: 'P-row („Éë, „Éî, „Éó, „Éö, „Éù)' },
					{ value: 'all_dakuon', label: 'ÂÖ®ÊøÅÈü≥„ÄåAll Dakuon„Äç' }
				],
				yoon: [
					{ value: 'ky_yoon', label: 'KY („Ç≠„É£, „Ç≠„É•, „Ç≠„Éß)' },
					{ value: 'sh_yoon', label: 'SH („Ç∑„É£, „Ç∑„É•, „Ç∑„Éß)' },
					{ value: 'ch_yoon', label: 'CH („ÉÅ„É£, „ÉÅ„É•, „ÉÅ„Éß)' },
					{ value: 'ny_yoon', label: 'NY („Éã„É£, „Éã„É•, „Éã„Éß)' },
					{ value: 'hy_yoon', label: 'HY („Éí„É£, „Éí„É•, „Éí„Éß)' },
					{ value: 'my_yoon', label: 'MY („Éü„É£, „Éü„É•, „Éü„Éß)' },
					{ value: 'ry_yoon', label: 'RY („É™„É£, „É™„É•, „É™„Éß)' },
					{ value: 'gy_yoon', label: 'GY („ÇÆ„É£, „ÇÆ„É•, „ÇÆ„Éß)' },
					{ value: 'j_yoon', label: 'J („Ç∏„É£, „Ç∏„É•, „Ç∏„Éß)' },
					{ value: 'by_yoon', label: 'BY („Éì„É£, „Éì„É•, „Éì„Éß)' },
					{ value: 'py_yoon', label: 'PY („Éî„É£, „Éî„É•, „Éî„Éß)' },
					{ value: 'all_yoon', label: 'ÂÖ®ÊãóÈü≥„ÄåAll Y≈çon„Äç' }
				]
			}
		};

		// Track current category
		let currentCategory = 'seion';

		window.selectCategory = (category) => {
			currentCategory = category;
			
			// Update tab active states
			document.querySelectorAll('.category-tab').forEach(tab => {
				tab.classList.remove('active');
				if (tab.dataset.category === category) {
					tab.classList.add('active');
				}
			});
			
			// Update section dropdown
			updateSectionDropdown();
		};

		function updateSectionDropdown() {
			const kanaTypeSelect = document.getElementById('kanaType');
			const sectionSelect = document.getElementById('kanaSection');
			const selectedType = kanaTypeSelect.value;
			
			// Clear current options
			sectionSelect.innerHTML = '';
			
			// Add new options based on selected kana type and category
			const options = SECTION_OPTIONS[selectedType][currentCategory];
			options.forEach(option => {
				const opt = document.createElement('option');
				opt.value = option.value;
				opt.textContent = option.label;
				sectionSelect.appendChild(opt);
			});
		}

		window.updateSectionOptions = () => {
			// Reset to seion category when kana type changes
			currentCategory = 'seion';
			document.querySelectorAll('.category-tab').forEach(tab => {
				tab.classList.remove('active');
				if (tab.dataset.category === 'seion') {
					tab.classList.add('active');
				}
			});
			updateSectionDropdown();
		};

		window.startKanaBlitz = () => {
			const kanaTypeSelect = document.getElementById('kanaType');
			const sectionSelect = document.getElementById('kanaSection');
			const timeLimitSelect = document.getElementById('timeLimit');
			
			const kanaType = kanaTypeSelect.value;
			const section = sectionSelect.value;
			const timeLimit = timeLimitSelect.value;
			
			state.kanaType = kanaType;
			state.kanaSection = section;
			state.sectionTimeLimit = timeLimit === 'unlimited' ? null : parseInt(timeLimit);
			
			// Set difficulty based on section
			if (section === 'all') {
				state.difficulty = 'medium';
			} else {
				state.difficulty = 'easy';
			}
			
			startGame();
		};

		// ===== ZENBU BURI (ALL KANA) =====
		window.startZenbuBuri = () => {
			const zenbuSelect = document.getElementById('zenbuBuri');
			const selection = zenbuSelect.value;
			
			if (!selection) {
				alert('Please select an option from Zenbu Buri!');
				return;
			}
			
			if (selection === 'all_hiragana') {
				state.kanaType = 'hiragana';
				state.kanaSection = 'all';
				state.difficulty = 'medium';
			} else if (selection === 'all_katakana') {
				state.kanaType = 'katakana';
				state.kanaSection = 'all';
				state.difficulty = 'medium';
			} else if (selection === 'comprehensive') {
				state.kanaType = 'comprehensive';
				state.kanaSection = 'all';
				state.difficulty = 'hard';
			}
			
			state.sectionTimeLimit = null;
			startGame();
		};

		// Keep for backwards compatibility
		window.startComprehensiveChallenge = () => {
			state.kanaType = 'comprehensive';
			state.difficulty = 'hard';
			state.kanaSection = 'all';
			state.sectionTimeLimit = null;
			startGame();
		};

		window.showGameMode = () => {            state.gameState = 'gameMode';            render();        };

		window.backToMenu = () => {
			state.gameState = 'menu';
			render();
		};

		window.setKanaType = (type) => {
			state.kanaType = type;
			render();
		};

		window.setDifficulty = (diff) => {
			state.difficulty = diff;
			render();
		};

		window.showStats = () => {
			state.gameState = 'stats';
			render();
		};

		window.showSettings = () => {
			state.gameState = 'settings';
			render();
		};

		window.changeTheme = (theme) => {
			// Remove all theme classes first
			document.body.classList.remove('midnight-theme');
			
			if (theme === 'midnight') {
				document.body.classList.add('midnight-theme');
				createStars();
			}
			// dawn is the default, no class needed
			
			localStorage.setItem('kanaBlitzTheme', theme);
		};

		window.changeAudio = (value) => {
			state.audioEnabled = value === 'on';
			localStorage.setItem('kanaBlitzAudio', state.audioEnabled);
		};

		window.switchStatsTab = (tab) => {
			state.statsTab = tab;
			render();
		};




		window.clearLeaderboard = () => {
			if (confirm('Clear all leaderboard data and achievements?')) {
				localStorage.removeItem('kanaBlitzLeaderboard');
				localStorage.removeItem('kanaBlitzAchievements');
				state.unlockedAchievements = [];
				state.totalRoundsPlayed = 0;
				state.hiraganaRoundsPlayed = 0;
				state.katakanaRoundsPlayed = 0;
				state.hardModeRounds = 0;
				state.hasPlayedHiragana = false;
				state.hasPlayedKatakana = false;
				render();
			}
		};



		// ===== INITIALIZE =====
		loadAchievementData();
		loadAudioPreference();
		loadThemePreference();
		render();
	</script>
</body>
</html>
